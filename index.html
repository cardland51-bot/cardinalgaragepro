<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport"
  content="width=device-width,initial-scale=1,viewport-fit=cover,maximum-scale=1,user-scalable=no" />
<title>JARED â€¢ HERO2 (Sod HUD)</title>
<meta name="theme-color" content="#0b1b16" />
<style>
  html, body {
    margin: 0;
    height: 100%;
    background: #0b1b16;
    overflow: hidden;
    touch-action: none;
    -webkit-user-select: none;
    user-select: none;
    -webkit-tap-highlight-color: transparent;
  }
</style>
</head>
<body>
<canvas id="hud"></canvas>

<script>
(() => {
  // ===== API base =====
  const API = (location.hostname.includes("localhost") || location.hostname.includes("127.0.0.1"))
    ? "http://localhost:3001"
    : "https://jared-hero2-backend.onrender.com";

  // ===== Theme =====
  const BRAND = {
    bgTop: "#0b1b16",
    bgBot: "#07100d",
    mintL: "#77FFCE",
    mintB: "#34D1A0",
    text: "#E9FFF6",
    textDim: "rgba(233,255,246,.85)",
    auraS: "rgba(119,255,206,.15)",
    auraM: "rgba(119,255,206,.35)",
    auraH: "rgba(119,255,206,.55)"
  };

  // ===== Icon defs =====
  const defs = [
    { id: "analyze", label: "Estimate", icon: "ðŸ§®" },
    { id: "talk", label: "Talk", icon: "ðŸŽ¤" },
    { id: "export", label: "Export", icon: "ðŸ“¤" },
    { id: "school", label: "Sales U", icon: "ðŸŽ“" },
    { id: "full", label: "Full", icon: "â›¶" },
  ];
  const ICONS = [];

  // ===== Canvas Setup =====
  const cvs = document.getElementById("hud");
  const ctx = cvs.getContext("2d", { alpha: false });
  let DPR = Math.max(1, Math.min(3, devicePixelRatio || 1));
  const S = { w: 0, h: 0, t: 0, tx: 0, ty: 0 };

  function layoutIcons() {
    ICONS.length = 0;
    const sodH = Math.max(120, Math.min(220, S.h * 0.22));
    const baseY = S.h - sodH + 10;
    const pad = 80;
    const gap = (S.w - pad * 2) / (defs.length - 1);
    defs.forEach((d, i) => {
      ICONS.push({
        ...d,
        x: pad + i * gap,
        y: S.h + 120,
        targetY: baseY - 70,
        r: 42,
        hover: false
      });
    });
  }

  function resize() {
    DPR = Math.max(1, Math.min(3, devicePixelRatio || 1));
    S.w = innerWidth;
    S.h = innerHeight;
    cvs.width = Math.floor(S.w * DPR);
    cvs.height = Math.floor(S.h * DPR);
    cvs.style.width = S.w + "px";
    cvs.style.height = S.h + "px";
    ctx.setTransform(DPR, 0, 0, DPR, 0, 0);
    layoutIcons();
  }
  addEventListener("resize", resize, { passive: true });
  resize();

  // ===== File Input =====
  const fileInput = document.createElement("input");
  fileInput.type = "file";
  fileInput.accept = "image/*";
  fileInput.style.display = "none";
  document.body.appendChild(fileInput);

  let lastFile = null;
  const photo = { img: null, url: null, w: 0, h: 0, show: false, glow: 0.4 };
  function chooseFile() {
    fileInput.value = "";
    fileInput.click();
  }
  fileInput.onchange = () => {
    const f = fileInput.files[0];
    if (!f) return;
    lastFile = f;
    if (photo.url) URL.revokeObjectURL(photo.url);
    photo.url = URL.createObjectURL(f);
    photo.img = new Image();
    photo.img.onload = () => {
      photo.w = photo.img.width;
      photo.h = photo.img.height;
      photo.show = true;
      photo.glow = 0.9;
      toast("âœ… Photo loaded. Tap Estimate to analyze.");
    };
    photo.img.src = photo.url;
  };

  // ===== Drawing =====
  function roundRect(g, x, y, w, h, r) {
    const rr = Math.min(r, w / 2, h / 2);
    g.beginPath();
    g.moveTo(x + rr, y);
    g.arcTo(x + w, y, x + w, y + h, rr);
    g.arcTo(x + w, y + h, x, y + h, rr);
    g.arcTo(x, y + h, x, y, rr);
    g.arcTo(x, y, x + w, y, rr);
    g.closePath();
  }

  function halo(r, color, blur) {
    ctx.save();
    ctx.shadowColor = color;
    ctx.shadowBlur = blur;
    ctx.beginPath();
    ctx.arc(0, 0, r, 0, Math.PI * 2);
    ctx.strokeStyle = "transparent";
    ctx.stroke();
    ctx.restore();
  }

  function drawBackground(t) {
    const g = ctx.createLinearGradient(0, 0, 0, S.h);
    g.addColorStop(0, BRAND.bgTop);
    g.addColorStop(1, BRAND.bgBot);
    ctx.fillStyle = g;
    ctx.fillRect(0, 0, S.w, S.h);
    const rg = ctx.createRadialGradient(S.w / 2, S.h * 0.85, 0, S.w / 2, S.h * 0.85, Math.max(S.w, S.h) * 0.55);
    rg.addColorStop(0, BRAND.auraM);
    rg.addColorStop(1, "transparent");
    ctx.fillStyle = rg;
    ctx.fillRect(0, 0, S.w, S.h);
  }

  function drawSod(t) {
    const sodTop = S.h - Math.max(120, Math.min(220, S.h * 0.22));
    const grd = ctx.createLinearGradient(0, sodTop, 0, S.h);
    grd.addColorStop(0, "#0e241c");
    grd.addColorStop(1, "#08130f");
    ctx.fillStyle = grd;
    ctx.fillRect(0, sodTop, S.w, S.h - sodTop);
    const blades = Math.floor(S.w / 9);
    for (let i = 0; i < blades; i++) {
      const x = (i / (blades - 1)) * S.w;
      const h = 22 + Math.sin((i * 0.6) + t * 0.002) * 6;
      const sway = Math.sin(t * 0.003 + i) * 2 + S.tx * 1.2;
      ctx.strokeStyle = i % 7 === 0 ? BRAND.mintL : BRAND.mintB;
      ctx.lineWidth = 2;
      ctx.beginPath();
      ctx.moveTo(x, sodTop + 2);
      ctx.quadraticCurveTo(x + sway, sodTop - h * 0.6, x + sway * 0.8, sodTop - h);
      ctx.stroke();
    }
  }

  function drawPhoto() {
    if (!photo.show || !photo.img) return;
    const maxW = S.w * 0.9;
    const maxH = S.h * 0.45;
    let w = photo.w, h = photo.h;
    const scale = Math.min(maxW / w, maxH / h);
    w *= scale; h *= scale;
    const x = (S.w - w) / 2;
    const y = S.h * 0.1;
    ctx.save();
    ctx.globalAlpha = photo.glow;
    ctx.drawImage(photo.img, x, y, w, h);
    ctx.restore();
  }

  // ===== Center Button with Pulse =====
  function drawUploadButton(t) {
    const r = 72;
    const x = S.w / 2;
    const y = S.h * 0.65;
    const pulse = 0.8 + Math.sin(t * 0.004) * 0.2;
    ctx.save();
    ctx.translate(x, y);
    halo(r + 20, `rgba(119,255,206,${0.4 + 0.3 * pulse})`, 28);
    const grd = ctx.createRadialGradient(-r * .3, -r * .5, r * .2, 0, 0, r * 1.3);
    grd.addColorStop(0, "#103524");
    grd.addColorStop(1, "#0b1b16");
    ctx.fillStyle = grd;
    roundRect(ctx, -r, -r, r * 2, r * 2, r * .45);
    ctx.fill();
    ctx.strokeStyle = BRAND.mintL;
    ctx.lineWidth = 4;
    ctx.beginPath();
    ctx.arc(0, 0, r - 3, 0, Math.PI * 2);
    ctx.stroke();
    ctx.font = Math.floor(r * 0.9) + "px serif";
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";
    ctx.fillText("â¬†ï¸", 0, 4);
    ctx.font = "700 16px system-ui";
    ctx.fillStyle = BRAND.text;
    ctx.shadowColor = BRAND.auraM;
    ctx.shadowBlur = 20;
    ctx.fillText("Upload = Estimate", 0, r + 26);
    ctx.restore();
  }

  // ===== Icon Drawing =====
  function drawIcon(it, t) {
    it.y += (it.targetY - it.y) * 0.1;
    const x = it.x, y = it.y, r = it.r;
    ctx.save();
    ctx.translate(x, y);
    halo(r + 14, it.hover ? BRAND.auraH : BRAND.auraM, 18);
    const grd = ctx.createRadialGradient(-r * .5, -r * .6, r * .2, 0, 0, r * 1.2);
    grd.addColorStop(0, "#10281f");
    grd.addColorStop(1, "#0a1a14");
    ctx.fillStyle = grd;
    roundRect(ctx, -r, -r, r * 2, r * 2, r * .42);
    ctx.fill();
    ctx.strokeStyle = it.hover ? BRAND.mintL : BRAND.mintB;
    ctx.lineWidth = 3;
    ctx.beginPath();
    ctx.arc(0, 0, r - 3, 0, Math.PI * 2);
    ctx.stroke();
    ctx.font = Math.floor(r * 0.9) + "px serif";
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";
    ctx.fillText(it.icon, 0, 2);
    ctx.font = "700 13px system-ui,sans-serif";
    ctx.fillStyle = BRAND.text;
    ctx.shadowColor = BRAND.auraM;
    ctx.shadowBlur = 14;
    ctx.fillText(it.label, 0, r + 18);
    ctx.restore();
  }

  // ===== Interaction =====
  function dist2(x1, y1, x2, y2) {
    const dx = x2 - x1, dy = y2 - y1;
    return dx * dx + dy * dy;
  }
  function handlePress(x, y) {
    if (dist2(x, y, S.w / 2, S.h * 0.65) < 90 * 90) return chooseFile();
    let best = null;
    for (const it of ICONS) {
      const R = it.r + 12;
      const d2 = dist2(x, y, it.x, it.y);
      if (d2 < R * R) best = it.id;
    }
    if (!best) return;
    if (best === "analyze") toast("Analyzing... (stub)");
    if (best === "export") toast("Exporting... (stub)");
    if (best === "school") window.open("https://cardland51-bot.github.io/sales-university/");
    if (best === "full") {
      if (!document.fullscreenElement) cvs.requestFullscreen();
      else document.exitFullscreen();
    }
  }
  cvs.addEventListener("pointerdown", (e) => {
    const r = cvs.getBoundingClientRect();
    handlePress(e.clientX - r.left, e.clientY - r.top);
  });

  // ===== Toasts =====
  const bubbles = [];
  function toast(msg, ms = 1600) {
    bubbles.push({ msg, t: performance.now(), ms });
  }
  function drawToasts() {
    const now = performance.now();
    bubbles.forEach((b, i) => {
      const age = now - b.t;
      if (age > b.ms) return;
      const a = age < 200 ? age / 200 : age > b.ms - 250 ? (b.ms - age) / 250 : 1;
      const w = Math.min(460, S.w * 0.9),
        h = 46,
        x = (S.w - w) / 2,
        y = S.h - 90 - i * 56;
      ctx.save();
      ctx.globalAlpha = a * 0.95;
      ctx.fillStyle = "rgba(10,26,20,.92)";
      ctx.strokeStyle = BRAND.auraM;
      ctx.lineWidth = 2;
      roundRect(ctx, x, y, w, h, 12);
      ctx.fill();
      ctx.stroke();
      ctx.fillStyle = BRAND.text;
      ctx.font = "600 14px system-ui,sans-serif";
      ctx.textAlign = "center";
      ctx.textBaseline = "middle";
      ctx.fillText(b.msg, x + w / 2, y + h / 2 + 1);
      ctx.restore();
    });
    for (let i = bubbles.length - 1; i >= 0; i--)
      if (performance.now() - bubbles[i].t > bubbles[i].ms) bubbles.splice(i, 1);
  }

  // ===== Main Loop =====
  function tick(t) {
    drawBackground(t);
    drawPhoto();
    drawSod(t);
    drawUploadButton(t);
    ICONS.forEach((it) => drawIcon(it, t));
    drawToasts();
    requestAnimationFrame(tick);
  }
  requestAnimationFrame(tick);
})();
</script>
</body>
</html>
