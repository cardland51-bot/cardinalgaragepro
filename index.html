<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,maximum-scale=1,user-scalable=no" />
<title>HeroHUD ‚Ä¢ Upload ‚Üí Analyze ‚Üí Send</title>
<meta name="theme-color" content="#0b1b16" />
<style>
  :root{
    --bg-top:#0b1b16; --bg-bot:#06121a;
    --mintL:#9CFFE0; --mint:#34D1A0; --aqua:#2FB0E9; --teal:#0E8B67;
    --text:#E9FFF6; --textDim:rgba(233,255,246,.85);
    --glass:rgba(255,255,255,0.05); --stroke:rgba(156,255,224,0.28);
    --doorTint:rgba(12,24,20,.82);
  }
  html,body{margin:0;height:100%;background:linear-gradient(180deg,var(--bg-top),var(--bg-bot));color:var(--text);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  *{box-sizing:border-box}
  body::before, body::after{content:""; position:fixed; inset:0; pointer-events:none}
  body::before{
    background:
      radial-gradient(130% 90% at 50% 6%, rgba(156,255,224,.10), transparent 45%),
      radial-gradient(120% 80% at 50% 95%, rgba(47,176,233,.12), transparent 55%);
    animation:film1 14s ease-in-out infinite alternate;
  }
  body::after{
    background:
      linear-gradient( to right, transparent 0%, rgba(156,255,224,.05) 30%, transparent 60%),
      linear-gradient( to left, transparent 0%, rgba(47,176,233,.05) 30%, transparent 60%);
    mix-blend-mode:screen; animation:film2 18s linear infinite;
  }
  @keyframes film1{to{transform:translateY(-2%)}}
  @keyframes film2{to{transform:translateX(-2%)}}

  /* Top branding */
  .topbar{position:fixed;inset:0 0 auto 0;height:64px;display:grid;place-items:center;z-index:10}
  .brand{font-weight:900;letter-spacing:.08em}
  .brand .hero{color:var(--mintL)}
  .tagline{position:fixed;top:12px;left:12px;font-size:11px;color:var(--textDim);opacity:.85}

  /* Stage */
  .stage{position:fixed;inset:64px 0 180px 0;display:grid;place-items:center;padding:18px}
  .stack{display:flex;flex-direction:column;align-items:center;text-align:center;gap:12px;max-width:1100px;width:100%}

  /* Buttons */
  .btn{appearance:none;border:1px solid var(--mint);background:var(--glass);color:var(--mintL);
    padding:.85rem 1.4rem;border-radius:999px;letter-spacing:.08em;text-transform:uppercase;
    font-weight:700;backdrop-filter:blur(6px);cursor:pointer;transition:box-shadow .2s,transform .1s,opacity .2s;
    box-shadow:0 0 16px rgba(156,255,224,.14);font-size:13px;position:relative;overflow:hidden;user-select:none}
  .btn:hover{box-shadow:0 0 26px rgba(156,255,224,.45),0 0 24px rgba(47,176,233,.25)}
  .btn:active{transform:translateY(1px)}
  .btn.hidden{display:none}
  .btn.locked{opacity:.55;cursor:not-allowed}
  .btn-row{display:flex;gap:10px;flex-wrap:wrap;justify-content:center}

  /* Preview */
  #preview{display:none;position:relative;width:min(96vw,1040px);aspect-ratio:16/10;border-radius:16px;overflow:hidden;border:1px solid var(--stroke);box-shadow:0 0 24px rgba(156,255,224,.14)}
  #preview img,#preview video{width:100%;height:100%;object-fit:cover}
  #edgeGlow{position:absolute;inset:0;border-radius:16px;pointer-events:none;opacity:0;
    box-shadow:0 0 28px rgba(156,255,224,.6),inset 0 0 18px rgba(14,139,103,.55);transition:opacity .25s}
  .glow-on #edgeGlow{opacity:1}
  .wheel{position:absolute;inset:auto auto 10px 10px;background:rgba(0,0,0,.35);border:1px solid var(--stroke);
    border-radius:999px;padding:.35rem .6rem;font-size:12px;display:flex;gap:.5rem;align-items:center}
  .mini-spin{width:14px;height:14px;border-radius:50%;border:2px solid rgba(156,255,224,.35);border-top-color:var(--mintL);animation:spin 1s linear infinite}
  @keyframes spin{to{transform:rotate(360deg)}}

  /* Rolling HUD text under photo */
  #hudStream{position:relative;width:min(96vw,1040px);min-height:40px;margin-top:6px}
  .line{opacity:0;transform:translateY(-6px);transition:all .35s ease;background:rgba(255,255,255,.04);
    border:1px solid var(--stroke);border-radius:10px;padding:.5rem .75rem;margin:.35rem auto;max-width:98%;text-align:left}
  .line.show{opacity:1;transform:translateY(0)}
  .line small{opacity:.8}

  /* Tip bubbles */
  #tips{position:relative;width:min(96vw,1040px);min-height:14px}
  .tip{opacity:0;transform:translateY(8px);transition:all .4s ease;background:rgba(255,255,255,.06);
    border:1px solid var(--stroke);backdrop-filter:blur(8px);color:var(--text);padding:.55rem .75rem;border-radius:10px;
    box-shadow:0 0 18px rgba(156,255,224,.25);margin:.35rem auto;max-width:98%}
  .tip.show{opacity:1;transform:translateY(0)}
  .tip.right{text-align:right}

  /* Tabs */
  .hud{display:flex;gap:8px;margin-top:8px;flex-wrap:wrap;justify-content:center}
  .tab{padding:.45rem .8rem;border:1px solid var(--stroke);border-radius:999px;background:rgba(255,255,255,.04);color:var(--textDim);font-size:12px;cursor:pointer}
  .tab.active{color:var(--mintL);border-color:var(--mint)}

  /* Side panels (modules) */
  .panelSlide{position:fixed; right:-420px; top:64px; bottom:180px; width:400px;
    background:rgba(6,18,26,.78); border-left:1px solid var(--stroke);
    backdrop-filter:blur(10px); transition:right .6s cubic-bezier(.2,.9,.2,1); z-index:35; overflow:auto; padding:14px}
  .panelSlide.open{right:0}
  .panelSlide h3{margin:.2rem 0 .4rem;font-weight:900;color:var(--mintL);letter-spacing:.06em}
  .panelSlide .hint{font-size:12px;color:var(--textDim);margin-bottom:8px}
  .pill{display:inline-block;border:1px solid var(--stroke);border-radius:999px;padding:.2rem .5rem;font-size:11px;margin:.1rem .2rem}

  /* Footer + Garage trigger */
  .footer{position:fixed;left:50%;transform:translateX(-50%);bottom:18px;font-size:12px;color:rgba(233,255,246,.8);letter-spacing:.12em;text-transform:uppercase;text-align:center}
  .garage-trigger{position:fixed;right:14px;bottom:54px;background:rgba(255,255,255,.05);border:1px solid var(--stroke);
    border-radius:12px;padding:.45rem .65rem;display:flex;align-items:center;gap:.45rem;cursor:pointer;
    box-shadow:0 0 12px rgba(156,255,224,.18);font-size:12px;z-index:30}
  .garage-trigger.pulse{animation:pulse 1.6s ease-in-out 3}
  @keyframes pulse{0%,100%{box-shadow:0 0 10px rgba(156,255,224,.2)}50%{box-shadow:0 0 22px rgba(156,255,224,.55)}}

  /* Overlays */
  .overlay{display:none;position:fixed;inset:0;background:rgba(3,8,6,.82);backdrop-filter:blur(6px);align-items:center;justify-content:center;z-index:60}

  /* GARAGE: roll-down door */
  #garageDoor{position:fixed;left:0;right:0;top:0;height:0;overflow:hidden;z-index:40;pointer-events:none}
  #garageDoor .door{height:420px;background:
      linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02)),
      repeating-linear-gradient(180deg, rgba(156,255,224,.07), rgba(156,255,224,.07) 6px, rgba(255,255,255,0.02) 6px, rgba(255,255,255,0.02) 16px),
      var(--doorTint);
    border-bottom:1px solid var(--stroke); box-shadow:0 10px 40px rgba(0,0,0,.35), inset 0 -8px 24px rgba(156,255,224,.12);
    display:flex;flex-direction:column;align-items:center;justify-content:flex-start;gap:12px;padding:14px 10px}
  #garageDoor.open{height:420px;pointer-events:auto;transition:height .9s cubic-bezier(.2,.9,.2,1)}
  #garageDoor.close{height:0;transition:height .8s cubic-bezier(.2,.9,.2,1)}
  .garageTitle{font-weight:900;letter-spacing:.16em;color:var(--mintL);margin-top:4px}
  .garageSub{opacity:.9;font-size:12px}
  .garageRow{display:flex;gap:12px;max-width:1100px;width:calc(100% - 20px);justify-content:center;flex-wrap:wrap;margin-top:6px}
  .card{flex:1 1 280px;max-width:340px;background:rgba(255,255,255,.05);border:1px solid var(--stroke);border-radius:14px;padding:12px 12px 14px;
    box-shadow:0 0 26px rgba(156,255,224,.18)}
  .tag{display:inline-block;border:1px solid var(--mint);color:var(--mintL);padding:.25rem .5rem;border-radius:999px;font-size:11px;margin-bottom:8px}
  .price{margin-top:8px;opacity:.9}
  .garageBtns{display:flex;gap:8px;margin-top:10px;flex-wrap:wrap}
  .garageClose{position:absolute;right:10px;top:10px;border:1px solid var(--stroke);background:rgba(255,255,255,.04);color:var(--text);border-radius:999px;padding:.35rem .6rem;cursor:pointer}

  /* Paywall overlay (export / upload gate) */
  #paywall{display:none}
  #paywall .panel{max-width:560px;margin:20px;background:rgba(255,255,255,.06);border:1px solid var(--stroke);
    border-radius:16px;padding:1.1rem 1.3rem;text-align:center;box-shadow:0 0 32px rgba(156,255,224,.28)}

  /* Boot titles */
  #bootTitles{position:fixed;inset:64px 0 0 0;display:grid;place-items:center;pointer-events:none;z-index:50}
  .bt{font-weight:900;letter-spacing:.22em;color:var(--mintL);font-size:clamp(22px,6vw,64px);opacity:0;transform:translateY(8px);transition:all .5s ease}
  .bt.show{opacity:1;transform:translateY(0)}

  /* Founders modal */
  #founders{display:none}
  #founders .panel{max-width:720px;margin:20px;background:rgba(255,255,255,.06);border:1px solid var(--stroke);
    border-radius:16px;padding:1.1rem 1.3rem;text-align:left;box-shadow:0 0 32px rgba(156,255,224,.28)}
  #founders h3{margin:.2rem 0 .6rem;color:var(--mintL);letter-spacing:.06em}
</style>
</head>
<body>
  <div class="tagline">Precision Meets Grit</div>
  <div class="topbar"><div class="brand"><span class="hero">HEROHUD</span></div></div>

  <div id="bootTitles">
    <div class="bt" id="bt1">UPLOAD</div>
    <div class="bt" id="bt2">ANALYZE</div>
    <div class="bt" id="bt3">SEND</div>
  </div>

  <!-- GARAGE roll-down (replaces Shop) -->
  <div id="garageDoor" class="close" aria-label="Garage Door">
    <div class="door" aria-live="polite">
      <button class="garageClose" id="garageCloseBtn">Close</button>
      <div class="garageTitle">THE GARAGE</div>
      <div class="garageSub">Tools ‚Ä¢ Systems ‚Ä¢ Training ‚Äî Powered by Cardinal-Garage_Mnd.inc</div>
      <div class="garageRow">
        <div class="card">
          <span class="tag">üß† Access+</span>
          <div>Unlimited uploads & daily analyses</div>
          <div class="price">Demo Active ‚úì</div>
          <div class="garageBtns">
            <button class="btn locked" disabled>Unlock (demo)</button>
          </div>
        </div>
        <div class="card">
          <span class="tag">‚ö° Pro Estimate</span>
          <div>Full report & sales insights export</div>
          <div class="price">Demo Active ‚úì</div>
          <div class="garageBtns">
            <button class="btn locked" disabled>Unlock (demo)</button>
          </div>
        </div>
        <div class="card">
          <span class="tag">üß∞ Hero Complete</span>
          <div>Everything ‚Ä¢ Voice ‚Ä¢ Field Guides ‚Ä¢ Ledger</div>
          <div class="price">Demo Active ‚úì</div>
          <div class="garageBtns">
            <button class="btn locked" disabled>Unlock (demo)</button>
          </div>
        </div>
      </div>
      <div class="garageSub" style="margin-top:6px;opacity:.85">‚ÄúPrecision Meets Grit‚Äù ‚Äî Cardinal Garage MND Inc.</div>
    </div>
  </div>

  <div class="stage">
    <div class="stack">
      <div class="btn-row">
        <button class="btn" id="btnUpload">‚¨Ü Upload Photo</button>
        <button class="btn" id="btnCamera">üì∑ Camera</button>
        <button class="btn" id="btnAnalyze">üîç Analyze</button>
        <button class="btn hidden" id="btnExport">üì§ Pro Estimate</button>
      </div>

      <div id="preview">
        <img id="previewImg" alt="preview" />
        <div id="edgeGlow"></div>
        <div class="wheel" id="wheel" style="display:none;">
          <div class="mini-spin"></div><span id="wheelText">Analyzing‚Ä¶</span>
        </div>
        <div id="dashHint" style="position:absolute;inset:0;opacity:.0;pointer-events:none;"></div>
      </div>

      <!-- Rolling HUD text + Tips container -->
      <div id="hudStream"></div>
      <div id="tips"></div>

      <!-- HUD tabs (modules) -->
      <div class="hud" id="hudTabs">
        <div class="tab" data-panel="panelInsights">Insights</div>
        <div class="tab" data-panel="panelGuides">Field Guides</div>
        <div class="tab" data-panel="panelSalesU">Sales U.</div>
        <div class="tab" data-panel="panelBest">Best Practices</div>
        <div class="tab" data-panel="panelLedger">Ledger</div>
        <div class="tab" data-panel="panelJourney">Join Our Journey</div>
        <div class="tab" id="tabFounders">Founders</div>
      </div>

      <!-- Panels -->
      <div id="panelInsights" class="panelSlide" aria-label="Insights">
        <h3>Insights</h3>
        <div class="hint">Context-aware notes Jared derives from your photo.</div>
        <div id="insightList"></div>
      </div>

      <div id="panelGuides" class="panelSlide" aria-label="Field Guides">
        <h3>Field Guides</h3>
        <div class="hint">Tools ‚Ä¢ Materials ‚Ä¢ Techniques</div>
        <div id="guideTools"><span class="pill">Tools</span></div>
        <div id="guideMaterials" style="margin-top:6px"><span class="pill">Materials</span></div>
        <div id="guideTech" style="margin-top:6px"><span class="pill">Techniques</span></div>
      </div>

      <div id="panelSalesU" class="panelSlide" aria-label="Sales University">
        <h3>Sales University</h3>
        <div class="hint">Actionable techniques to close more jobs.</div>
        <ul id="salesTips" style="padding-left:18px;line-height:1.5">
          <!-- populated per analysis -->
        </ul>
      </div>

      <div id="panelBest" class="panelSlide" aria-label="Best Practices">
        <h3>Best Practices</h3>
        <div class="hint">Industry-proven sequences & checklists.</div>
        <ul style="padding-left:18px;line-height:1.5" id="bestList">
          <li>Edge before you mulch to lock the frame.</li>
          <li>Trim shrubs to consistent height for a unified line.</li>
          <li>Use fabric selectively‚Äîdrainage first, then aesthetics.</li>
        </ul>
      </div>

      <div id="panelLedger" class="panelSlide" aria-label="Estimate Ledger">
        <h3>Ledger</h3>
        <div class="hint">Recent analyses (local, private)</div>
        <div id="ledgerList" style="font-size:13px"></div>
        <div class="btn-row" style="margin-top:8px">
          <button class="btn" id="btnLedgerExport">Export Ledger (.txt)</button>
          <button class="btn" id="btnLedgerClear">Clear Ledger</button>
        </div>
      </div>

      <div id="panelJourney" class="panelSlide" aria-label="Journey">
        <h3>Join Our Journey</h3>
        <div class="hint">Stories, before/afters, releases</div>
        <div id="journeyFeed">
          <div class="line show"><small>Update</small><br>Welcome to the Cardinal Garage edition of HeroHUD. Precision meets grit.</div>
          <div class="line show"><small>Community</small><br>Share your best before/after ‚Äî inspire the feed.</div>
        </div>
      </div>

      <input type="file" id="file" accept="image/*" hidden />
    </div>
  </div>

  <div class="garage-trigger" id="garageTrigger">üß∞ Garage</div>
  <div class="footer">
    Powered by Cardinal-Garage_Mnd.inc ‚Ä¢ Precision Meets Grit<br/>
    <span style="opacity:.85">Founders tab: About Me</span>
  </div>

  <!-- Paywall overlay -->
  <div class="overlay" id="paywall">
    <div class="panel">
      <h3 id="paywallTitle">Pro Required</h3>
      <p id="paywallMsg" class="sub">Unlock to continue.</p>
      <div class="btn-row">
        <button class="btn" id="btnProOnce">$1 / report</button>
        <button class="btn" id="btnProMonthly">$75 / month</button>
        <button class="btn" id="btnPaywallClose">Close</button>
      </div>
    </div>
  </div>

  <!-- Founders overlay -->
  <div class="overlay" id="founders">
    <div class="panel">
      <h3>Founders</h3>
      <p style="opacity:.9">Cardinal Systems ‚Ä¢ Cardinal Garage MND Inc.</p>
      <p style="opacity:.85">About Me: Built from hands-on fieldwork and engineering discipline ‚Äî HeroHUD bridges AI precision with real-world grit. Every feature is designed to help crews move faster, sell smarter, and deliver consistent results.</p>
      <div class="btn-row"><button class="btn" id="btnFoundersClose">Close</button></div>
    </div>
  </div>

<script>
(() => {
  // ===== API base =====
  const API = (location.hostname.includes("localhost")||location.hostname.includes("127.0.0.1"))
    ? "http://localhost:3001"
    : "https://jared-hero2-backend.onrender.com";

  // ===== Elements
  const el = {
    file: q('#file'),
    btnUpload: q('#btnUpload'),
    btnCamera: q('#btnCamera'),
    btnAnalyze: q('#btnAnalyze'),
    btnExport: q('#btnExport'),
    preview: q('#preview'),
    previewImg: q('#previewImg'),
    wheel: q('#wheel'),
    wheelText: q('#wheelText'),
    dashHint: q('#dashHint'),
    hudTabs: q('#hudTabs'),
    hudStream: q('#hudStream'),
    tips: q('#tips'),
    garageTrigger: q('#garageTrigger'),
    garageDoor: q('#garageDoor'),
    garageCloseBtn: q('#garageCloseBtn'),
    paywall: q('#paywall'),
    paywallTitle: q('#paywallTitle'),
    paywallMsg: q('#paywallMsg'),
    btnProOnce: q('#btnProOnce'),
    btnProMonthly: q('#btnProMonthly'),
    btnPaywallClose: q('#btnPaywallClose'),
    founders: q('#founders'),
    btnFoundersClose: q('#btnFoundersClose'),
    tabFounders: q('#tabFounders'),
    // Panels
    panelInsights: q('#panelInsights'),
    panelGuides: q('#panelGuides'),
    panelSalesU: q('#panelSalesU'),
    panelBest: q('#panelBest'),
    panelLedger: q('#panelLedger'),
    panelJourney: q('#panelJourney'),
    // Lists
    insightList: q('#insightList'),
    guideTools: q('#guideTools'),
    guideMaterials: q('#guideMaterials'),
    guideTech: q('#guideTech'),
    salesTips: q('#salesTips'),
    ledgerList: q('#ledgerList'),
    boot: { t1:q('#bt1'), t2:q('#bt2'), t3:q('#bt3') }
  };

  // ===== State
  const STATE = {
    proUnlocked: localStorage.getItem('herohud_pro_unlocked')==='1',
    accessUnlocked: localStorage.getItem('herohud_access_unlocked')==='1',
    uploadsToday: getUploadsToday(),
    lastSummary: "",
    firstRun: !localStorage.getItem('herohud_first_run'),
    freeDemoAnalysisUsed: localStorage.getItem('herohud_demo_analysis_used')==='1',
    analyzing: false,
    ledger: loadLedger()
  };

  // ===== Helpers
  function q(s){return document.querySelector(s)}
  function qa(s){return Array.from(document.querySelectorAll(s))}
  function nowKey(){ const d=new Date(); return d.getFullYear()+'-'+(d.getMonth()+1)+'-'+d.getDate() }
  function getUploadsToday(){
    const key = localStorage.getItem('herohud_uploads_key');
    const count = Number(localStorage.getItem('herohud_uploads_count')||0);
    const today = nowKey();
    return key===today?count:0;
  }
  function bumpUploads(){
    const today = nowKey();
    localStorage.setItem('herohud_uploads_key', today);
    const n = STATE.uploadsToday+1;
    localStorage.setItem('herohud_uploads_count', String(n));
    STATE.uploadsToday = n;
  }
  function escapeHTML(s){return s.replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]))}
  function wait(ms){ return new Promise(r=>setTimeout(r,ms)) }

  // ===== Voice (graceful no-op if /speak not present)
  let voiceEnabled = false; // toggled after a user gesture
  let currentAudio = null;
  async function speak(text){
    if(!voiceEnabled) { pushLine(text, "Jared"); return; }
    try{
      // Optional: stream audio; minimal demo uses text to HUD if not available
      const resp = await fetch(`${API}/speak`, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({text})});
      if(!resp.ok) { pushLine(text,"Jared"); return; }
      const blob = await resp.blob();
      if(currentAudio){ currentAudio.pause(); }
      currentAudio = new Audio(URL.createObjectURL(blob));
      currentAudio.play().catch(()=>{ /* ignore autoplay issues */ });
      pushLine(text, "Jared");
    }catch(e){ pushLine(text,"Jared"); }
  }
  function stopSpeak(){
    if(currentAudio){ currentAudio.pause(); currentAudio=null; }
  }

  // ===== Rolling HUD text + Tips
  function pushLine(text, meta="Jared"){
    const div = document.createElement('div');
    div.className='line';
    div.innerHTML = `<small>${meta}</small><br>${escapeHTML(text)}`;
    el.hudStream.appendChild(div);
    requestAnimationFrame(()=>div.classList.add('show'));
  }
  function showTip(text,right=false){
    const t = document.createElement('div');
    t.className = 'tip'+(right?' right':'');
    t.textContent = text;
    el.tips.appendChild(t);
    requestAnimationFrame(()=>t.classList.add('show'));
    setTimeout(()=>{ t.classList.remove('show'); setTimeout(()=>t.remove(),380); }, 4200);
  }

  // ===== Panels toggle
  qa('.tab[data-panel]').forEach(tab=>{
    tab.onclick=()=>{
      qa('.tab').forEach(t=>t.classList.remove('active'));
      tab.classList.add('active');
      const target = tab.getAttribute('data-panel');
      qa('.panelSlide').forEach(p=>p.classList.remove('open'));
      q('#'+target).classList.add('open');
    };
  });

  // ===== Founders overlay
  el.tabFounders.onclick = ()=>{ el.founders.style.display='flex'; };
  el.btnFoundersClose.onclick = ()=>{ el.founders.style.display='none'; };

  // ===== Garage (roll-down door)
  function openGarage(){
    el.garageDoor.classList.remove('close');
    el.garageDoor.classList.add('open');
  }
  function closeGarage(){
    el.garageDoor.classList.remove('open');
    el.garageDoor.classList.add('close');
  }
  el.garageTrigger.onclick = ()=> openGarage();
  el.garageCloseBtn.onclick = ()=> closeGarage();

  // ===== Paywall generic
  function openPaywall(title,msg){
    el.paywallTitle.textContent = title;
    el.paywallMsg.textContent = msg;
    el.paywall.style.display='flex';
  }
  function closePaywall(){ el.paywall.style.display='none' }
  el.btnPaywallClose.onclick = () => closePaywall();

  el.btnProOnce.onclick = () => { // simulate one-time unlock (export)
    localStorage.setItem('herohud_pro_unlocked','1');
    STATE.proUnlocked = true;
    speak("Pro access confirmed. Generating your full estimate now.");
    closePaywall();
    triggerExport();
  };
  el.btnProMonthly.onclick = () => {
    localStorage.setItem('herohud_pro_unlocked','1');
    localStorage.setItem('herohud_access_unlocked','1');
    STATE.proUnlocked = true; STATE.accessUnlocked = true;
    speak("Subscription active. Unlimited exports and uploads are now enabled.");
    closePaywall();
  };

  // ===== Upload gating (2/day unless access unlocked)
  function canUpload(){
    if(STATE.accessUnlocked) return true;
    return STATE.uploadsToday < 2;
  }
  function enforceUploadGate(){
    if(canUpload()) return true;
    speak("You've reached today's free upload limit. Open the Garage to unlock unlimited access.");
    openPaywall("Daily Access Limit Reached","You‚Äôve used your 2 free uploads today. Unlock Access+ for unlimited uploads.");
    return false;
  }

  // ===== Voice Enable (one tap to allow audio)
  // Any button click enables voice for this session
  [el.btnUpload, el.btnCamera, el.btnAnalyze, el.garageTrigger].forEach(b=>{
    b.addEventListener('click', ()=>{ voiceEnabled = true; }, { once:true });
  });

  // ===== Boot sequence + first-run Garage demo
  async function boot(){
    await speak("Please wait while I wake up.");
    setTimeout(()=>el.boot.t1.classList.add('show'), 500);
    await wait(900);
    setTimeout(()=>el.boot.t2.classList.add('show'), 950);
    await wait(900);
    setTimeout(()=>el.boot.t3.classList.add('show'), 950);

    await speak("Precision meets grit ‚Äî powered by Cardinal Garage MND Inc.");

    // Show Garage demo once on first run
    if(STATE.firstRun){
      await wait(900);
      el.garageTrigger.classList.add('pulse');
      await speak("Opening the Garage. This is where you‚Äôll unlock access, exports, and tools.");
      openGarage();
      await wait(2200);
      await speak("This is a demo preview. You can explore upgrades anytime.");
      await wait(1000);
      closeGarage();
      el.garageTrigger.classList.remove('pulse');
      localStorage.setItem('herohud_first_run','1');
    }

    // Hide boot titles
    await wait(800);
    el.boot.t1.style.display='none'; el.boot.t2.style.display='none'; el.boot.t3.style.display='none';
    await speak("Ready when you are. Upload a photo to begin.");
  }

  // ===== Upload
  el.btnUpload.onclick = ()=> {
    if(!enforceUploadGate()) return;
    el.file.click();
  };

  el.file.onchange=()=>{
    const f=el.file.files[0]; if(!f) return;
    const url=URL.createObjectURL(f);
    previewReplaceWithImage(url);
    el.preview.style.display='block';
    el.dashHint.style.opacity=.25;
    bumpUploads();
    showTip(STATE.uploadsToday<=2 ? "Photo loaded ‚Äî tap Analyze." : "Photo loaded.", true);
  };

  // ===== Camera
  let camStream=null,camVideo=null,captureBtn=null;
  el.btnCamera.onclick = openCamera;
  async function openCamera(){
    if(!enforceUploadGate()) return;
    try{
      const stream=await navigator.mediaDevices.getUserMedia({video:true});
      camStream=stream;
      camVideo=document.createElement("video");
      camVideo.playsInline=true; camVideo.muted=true; camVideo.srcObject=stream; await camVideo.play();
      el.preview.style.display='block'; previewReplaceWithNode(camVideo); ensureCaptureBtn();
    }catch(e){ showTip("Camera access denied.",true); }
  }
  function ensureCaptureBtn(){
    if(captureBtn) captureBtn.remove();
    captureBtn=document.createElement("button");
    captureBtn.textContent="üì∏ Capture"; captureBtn.className="btn";
    captureBtn.style.position="absolute"; captureBtn.style.right="10px"; captureBtn.style.bottom="10px";
    el.preview.appendChild(captureBtn);
    captureBtn.onclick=async()=>{
      if(!camVideo) return;
      const canvas=document.createElement("canvas");
      canvas.width=camVideo.videoWidth||1280; canvas.height=camVideo.videoHeight||720;
      const g=canvas.getContext("2d"); g.drawImage(camVideo,0,0,canvas.width,canvas.height);
      const blob=await new Promise(res=>canvas.toBlob(res,'image/jpeg',0.92));
      if(camStream){camStream.getTracks().forEach(t=>t.stop()); camStream=null;}
      camVideo=null;
      const url=URL.createObjectURL(blob); previewReplaceWithImage(url);
      el.preview.style.display='block'; el.dashHint.style.opacity=.25;
      el.file._capturedBlob = blob;
      bumpUploads();
      showTip("Captured ‚Äî tap Analyze.", true);
    };
  }

  // ===== Preview helpers
  function previewReplaceWithImage(url){
    const img=document.createElement("img");
    img.id="previewImg"; img.alt="preview"; img.src=url;
    previewReplaceWithNode(img);
  }
  function previewReplaceWithNode(node){
    const old=el.preview.querySelector("img,video");
    if(old) old.replaceWith(node); else el.preview.prepend(node);
  }

  // ===== Analyze
  el.btnAnalyze.onclick = async ()=>{
    if(!el.preview.style.display || el.preview.style.display==='none'){
      showTip("Upload or capture a photo first.", true); return;
    }
    const isDemoAnalysis = !STATE.freeDemoAnalysisUsed;

    const blob = el.file._capturedBlob;
    const fileEl = el.file.files && el.file.files[0];
    if(!blob && !fileEl){ showTip("No image found.", true); return; }

    STATE.analyzing = true;
    el.preview.classList.add('glow-on');
    el.wheel.style.display='flex'; el.wheelText.textContent = "Analyzing‚Ä¶";

    const formData=new FormData();
    if(blob) formData.append("file",blob,"capture.jpg"); else formData.append("file",fileEl);

    try{
      speak("Analyzing image now.");
      pushLine("Analyzing image‚Ä¶", "System");
      const resp = await fetch(`${API}/analyze-image`, { method:"POST", body:formData });
      const data = await resp.json();
      STATE.lastSummary = data.summary || "No summary.";

      // Rolling readout lines
      pushLine(STATE.lastSummary, "Analysis");

      // Populate panels
      populateInsights(STATE.lastSummary);
      populateGuides(STATE.lastSummary);
      populateSalesU(STATE.lastSummary);

      // Tips (3)
      showAnalysisTips(STATE.lastSummary);

      el.btnExport.classList.remove('hidden');
      el.dashHint.style.opacity=.6;

      if(isDemoAnalysis){
        localStorage.setItem('herohud_demo_analysis_used','1');
        STATE.freeDemoAnalysisUsed = true;
        speak("Analysis complete. This was your full demo run. You can keep analyzing and export anytime from Pro Estimate.");
      } else {
        speak("Analysis complete.");
      }

      // Save to ledger
      saveLedgerEntry({ when:(new Date()).toLocaleString(), summary: STATE.lastSummary });
      renderLedger();

    }catch(e){
      showTip("‚ùå Analysis failed.", true);
      pushLine("Analysis failed. Please try again.","System");
    } finally {
      el.wheel.style.display='none';
      el.preview.classList.remove('glow-on');
      STATE.analyzing = false;
    }
  };

  function populateInsights(summary){
    el.insightList.innerHTML = `
      <div class="line show"><small>Visual</small><br>${escapeHTML(summary)}</div>
    `;
  }
  function populateGuides(summary){
    // Simple demo extraction; replace with server-side parse if desired
    el.guideTools.innerHTML = `<span class="pill">Tools</span> <span class="pill">Half-moon edger</span> <span class="pill">String trimmer</span>`;
    el.guideMaterials.innerHTML = `<span class="pill">Materials</span> <span class="pill">Brown mulch</span> <span class="pill">Landscape fabric</span>`;
    el.guideTech.innerHTML = `<span class="pill">Techniques</span> <span class="pill">Define bed edge</span> <span class="pill">Uniform trim</span>`;
  }
  function populateSalesU(summary){
    el.salesTips.innerHTML = `
      <li>üè° Lead with curb appeal. ‚ÄúLet‚Äôs lock in that clean edge for the season.‚Äù</li>
      <li>üåø Position mulch color as a design choice, not upkeep.</li>
      <li>üí¨ Ask for the yes: ‚ÄúWant me to schedule the refresh?‚Äù</li>
    `;
  }

  function showAnalysisTips(summary){
    const bits=(summary.replace(/\s+/g,' ').trim()||"Looks good. Consider fresh mulch; adjust shrub spacing; check edging.")
      .split(/[.;]/).map(s=>s.trim()).filter(Boolean).slice(0,3);
    let delay=240;
    bits.forEach((b,i)=>{ setTimeout(()=>showTip("üí° "+b, i%2===1), delay); delay+=1400; });
    setTimeout(()=>showTip("üßæ Pro Estimate available ‚Äî tap Export when ready.", true), delay+260);
  }

  // ===== Export (Pro paywall only here)
  el.btnExport.onclick = ()=>{
    if(!STATE.proUnlocked){
      speak("You‚Äôll need Pro access to export the full report.");
      openPaywall("Pro Estimate Required","Export the full analysis report with sales insights.");
      return;
    }
    triggerExport();
  };

  async function triggerExport(){
    try{
      const tipsTxt=[...document.querySelectorAll('.tip')].map(e=>e.textContent.trim()).join("\n");
      const logTxt=[...document.querySelectorAll('.line')].map(e=>e.innerText.trim()).join("\n");
      const payload = { summary: STATE.lastSummary, tips: tipsTxt, log: logTxt };
      pushLine("Generating Pro Estimate‚Ä¶", "System");
      const resp = await fetch(`${API}/export`, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload) });
      if(resp.ok && resp.headers.get('content-type')?.includes('application/pdf')){
        const blob = await resp.blob();
        const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download="herohud_pro_estimate.pdf"; a.click();
      }else{
        const text = `HeroHUD Pro Estimate\n\nSummary:\n${STATE.lastSummary}\n\nTips:\n${tipsTxt}\n\nConversation Log:\n${logTxt}`;
        const blob=new Blob([text],{type:"text/plain"});
        const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download="herohud_pro_estimate.txt"; a.click();
      }
      speak("Export complete.");
    }catch(e){
      showTip("Export failed. Try again.", true);
      pushLine("Export failed.", "System");
    }
  }

  // ===== Ledger (local)
  function loadLedger(){
    try{ return JSON.parse(localStorage.getItem('herohud_ledger')||'[]'); }catch(e){ return []; }
  }
  function saveLedger(){
    localStorage.setItem('herohud_ledger', JSON.stringify(STATE.ledger.slice(-20)));
  }
  function saveLedgerEntry(entry){
    STATE.ledger.push(entry);
    saveLedger();
  }
  function renderLedger(){
    el.ledgerList.innerHTML = STATE.ledger.slice(-20).map(i=>(
      `<div class="line show"><small>${escapeHTML(i.when)}</small><br>${escapeHTML(i.summary)}</div>`
    )).join('');
  }
  q('#btnLedgerExport').onclick = ()=>{
    const text = STATE.ledger.map(i=>`${i.when}\n${i.summary}\n`).join('\n');
    const blob=new Blob([text],{type:"text/plain"});
    const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download="herohud_ledger.txt"; a.click();
  };
  q('#btnLedgerClear').onclick = ()=>{
    STATE.ledger = []; saveLedger(); renderLedger(); showTip("Ledger cleared.", true);
  };

  // ===== Init
  renderLedger();
  boot();

})();
</script>
</body>
</html>
