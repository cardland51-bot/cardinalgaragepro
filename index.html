<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,maximum-scale=1,user-scalable=no" />
<title>HERO PRO ‚Ä¢ JARED ‚Ä¢ Upload ‚Üí Estimate ‚Üí Send</title>
<meta name="theme-color" content="#0b1b16" />
<style>
:root{
  --bg-top:#0b1b16; --bg-bot:#06121a;
  --mintL:#9CFFE0; --mint:#34D1A0; --aqua:#2FB0E9; --teal:#0E8B67;
  --text:#E9FFF6; --textDim:rgba(233,255,246,.85);
  --glass:rgba(255,255,255,0.05); --stroke:rgba(156,255,224,0.28);
}
html,body{margin:0;height:100%;background:linear-gradient(180deg,var(--bg-top),var(--bg-bot));color:var(--text);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
*{box-sizing:border-box}

/* top & layout styles (shortened for clarity) */
.stage{position:fixed;inset:64px 0 148px 0;display:grid;place-items:center;padding:18px}
.stack{display:flex;flex-direction:column;align-items:center;text-align:center;gap:12px;max-width:960px;width:100%}
.btn{border:1px solid var(--mint);background:var(--glass);color:var(--mintL);padding:.85rem 1.4rem;border-radius:999px;cursor:pointer;font-weight:700;text-transform:uppercase}
.btn.hidden{display:none}
.boot{position:fixed;inset:0;display:grid;place-items:center;background:rgba(3,8,6,.78);backdrop-filter:blur(4px);z-index:70}
.spinner{width:74px;height:74px;border-radius:50%;border:3px solid rgba(156,255,224,.3);border-top-color:var(--mintL);animation:spin 1s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.tip{position:absolute;max-width:340px;background:rgba(255,255,255,.06);border:1px solid var(--stroke);backdrop-filter:blur(8px);color:var(--text);padding:.7rem .9rem;border-radius:12px;box-shadow:0 0 18px rgba(156,255,224,.25);opacity:0;transform:translateX(-40px);transition:transform .6s,opacity .6s}
.tip.show{opacity:1;transform:translateX(0)}
</style>
</head>
<body>

<!-- Boot overlay -->
<div class="boot" id="boot">
  <div class="stack">
    <div class="spinner"></div>
    <p><strong>Please give Addison a moment to wake up.</strong><br/>
      <span class="caption">Booting systems ‚Äî calibrating voice.</span>
    </p>
  </div>
</div>

<!-- Stage -->
<div class="stage">
  <div class="stack">
    <div class="module primary-row">
      <button class="btn" id="btnUpload">‚¨Ü Upload Photo</button>
      <button class="btn" id="btnEstimate">üîç Estimate</button>
      <button class="btn hidden" id="btnExport">üì§ Export Insight</button>
    </div>
    <div id="preview" style="display:none;position:relative;">
      <img id="previewImg" alt="preview" style="width:100%;border-radius:16px"/>
      <div class="wheel" id="wheel" style="display:none;position:absolute;bottom:10px;left:10px;background:rgba(0,0,0,.4);padding:.3rem .6rem;border-radius:12px;color:#9CFFE0;font-size:12px">
        <div class="mini-spin" style="width:14px;height:14px;border-radius:50%;border:2px solid rgba(156,255,224,.35);border-top-color:#9CFFE0;animation:spin 1s linear infinite"></div>
        <span id="wheelText">Analyzing‚Ä¶</span>
      </div>
    </div>
    <input type="file" id="file" accept="image/*" hidden />
  </div>
</div>

<div class="tips" id="tips"></div>

<script>
(() => {
  // ===== API base =====
  const API = (location.hostname.includes("localhost")||location.hostname.includes("127.0.0.1"))
    ? "http://localhost:3001"
    : "https://jared-hero2-backend.onrender.com";

  // ===== Elements =====
  const boot = document.getElementById('boot');
  const file = document.getElementById('file');
  const btnUpload = document.getElementById('btnUpload');
  const btnEstimate = document.getElementById('btnEstimate');
  const btnExport = document.getElementById('btnExport');
  const preview = document.getElementById('preview');
  const previewImg = document.getElementById('previewImg');
  const wheel = document.getElementById('wheel');
  const wheelText = document.getElementById('wheelText');
  const tips = document.getElementById('tips');
  let lastSummary = "";

  // ===== Speech / Audio =====
  let speechAudio = null;

  async function speak(text){
    if(!text) return;
    try{
      if(speechAudio){ speechAudio.pause(); speechAudio=null; }
      const r = await fetch(`${API}/speak`,{
        method:'POST', headers:{'Content-Type':'application/json'},
        body:JSON.stringify({ text })
      });
      if(!r.ok) throw new Error('tts');
      const b = await r.blob(); const u = URL.createObjectURL(b);
      speechAudio = new Audio(u);
      await speechAudio.play();
    }catch(e){
      console.log('TTS unavailable, fallback speak:', text);
    }
  }

  // ===== Greeting =====
  async function greeting(){
    await new Promise(r => setTimeout(r, 800));
    boot.style.display = 'none';
    const lines = [
      "Yo, yo, yo ‚Äî Addison here. I‚Äôm in beta mode, so please be patient with me.",
      "I‚Äôm basically your personal sales coach ‚Äî ready to calculate costs, analyze your work, and identify upsell opportunities using proprietary insights.",
      "Upload a photo, hit estimate, and let‚Äôs see what this thing can do."
    ];
    for (const line of lines) {
      await speak(line);
      await new Promise(r => setTimeout(r, 250));
    }
  }

  // ===== Fail-safes =====
  window.addEventListener('load', greeting, { once:true });
  setTimeout(() => {
    if (boot && boot.style.display !== 'none') {
      console.warn('AI backend slow ‚Äî skipping boot overlay');
      boot.style.display = 'none';
    }
  }, 10000);

  if (typeof speak === 'undefined') {
    async function speak(text){ console.log('Fallback speak:', text); return new Promise(r=>setTimeout(r,1000)); }
  }

  // ===== Upload flow =====
  btnUpload.onclick = ()=> file.click();
  file.onchange = ()=>{
    const f = file.files[0]; if(!f) return;
    const url = URL.createObjectURL(f);
    preview.style.display='block';
    previewImg.src = url;
  };

  // ===== Analyze =====
  btnEstimate.onclick = async ()=>{
    const fileEl = file.files && file.files[0];
    if(!fileEl){ showTip("Upload a photo first.", true); return; }
    wheel.style.display='flex'; wheelText.textContent="Analyzing‚Ä¶";

    const formData = new FormData();
    formData.append("file", fileEl);

    try{
      const resp = await fetch(`${API}/analyze-image`, { method:"POST", body:formData });
      const data = await resp.json();
      lastSummary = data.summary || "No summary.";
      showAnalysisTips(lastSummary);
      await speak(lastSummary);
      btnExport.classList.remove('hidden');
    }catch{
      showTip("‚ùå Analysis failed.", true);
    }finally{
      wheel.style.display='none';
    }
  };

  // ===== Export =====
  btnExport.onclick = ()=>{
    const content = `HERO PRO ‚Äî Estimate Insight\n\n${lastSummary}\n`;
    const blob = new Blob([content], { type:"text/plain" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "jared_estimate.txt";
    a.click();
  };

  // ===== Tips / Feedback =====
  function showTip(text){
    const el=document.createElement('div');
    el.className='tip';
    el.innerHTML=text;
    tips.appendChild(el);
    requestAnimationFrame(()=>el.classList.add('show'));
    setTimeout(()=>{ el.classList.remove('show'); setTimeout(()=>el.remove(),420); }, 4200);
  }

  function showAnalysisTips(summary){
    const bits = (summary.replace(/\s+/g,' ').trim() || 
      "Looks good. Consider fresh mulch; adjust shrub spacing; check edging.")
      .split(/[.;]/).map(s=>s.trim()).filter(Boolean).slice(0,3);
    let delay = 240;
    bits.forEach((b,i)=>{
      setTimeout(()=>showTip("üí° "+b), delay);
      delay += 1500;
    });
    setTimeout(()=>showTip("üßæ Estimate ready ‚Äî Export or upgrade to Pro."), delay+300);
  }

})();
</script>
</body>
</html>

