<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,maximum-scale=1,user-scalable=no" />
<title>HeroHUD ‚Ä¢ Upload ‚Üí Analyze ‚Üí Send</title>
<meta name="theme-color" content="#0b1b16" />
<style>
  :root{
    --bg-top:#0b1b16; --bg-bot:#06121a;
    --mintL:#9CFFE0; --mint:#34D1A0; --aqua:#2FB0E9; --teal:#0E8B67;
    --text:#E9FFF6; --textDim:rgba(233,255,246,.85);
    --glass:rgba(255,255,255,0.05); --stroke:rgba(156,255,224,0.28);
  }
  html,body{margin:0;height:100%;background:linear-gradient(180deg,var(--bg-top),var(--bg-bot));color:var(--text);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  *{box-sizing:border-box}

  /* Ambient films */
  body::before, body::after{content:""; position:fixed; inset:0; pointer-events:none}
  body::before{
    background:
      radial-gradient(130% 90% at 50% 6%, rgba(156,255,224,.10), transparent 45%),
      radial-gradient(120% 80% at 50% 95%, rgba(47,176,233,.12), transparent 55%);
    animation:film1 14s ease-in-out infinite alternate; opacity:.8;
  }
  body::after{
    background:
      linear-gradient( to right, transparent 0%, rgba(156,255,224,.05) 30%, transparent 60%),
      linear-gradient( to left, transparent 0%, rgba(47,176,233,.05) 30%, transparent 60%);
    mix-blend-mode:screen; animation:film2 18s linear infinite; opacity:.7;
  }
  @keyframes film1{to{transform:translateY(-2%)}} @keyframes film2{to{transform:translateX(-2%)}}

  /* Topbar + controls */
  .topbar{position:fixed;inset:0 0 auto 0;height:64px;display:grid;place-items:center;z-index:10}
  .brand{font-weight:900;letter-spacing:.08em}
  .brand .hero{color:var(--mintL)}
  .topright{position:fixed;top:10px;right:10px;display:flex;gap:8px;z-index:12}
  .iconbtn{width:40px;height:40px;border-radius:10px;border:1px solid var(--stroke);background:rgba(255,255,255,.06);display:grid;place-items:center;cursor:pointer;box-shadow:0 0 12px rgba(156,255,224,.18)}
  .iconbtn:active{transform:scale(.98)}

  /* Stage */
  .stage{position:fixed;inset:64px 0 160px 0;display:grid;place-items:center;padding:18px}
  .stack{display:flex;flex-direction:column;align-items:center;text-align:center;gap:12px;max-width:960px;width:100%}

  /* Buttons */
  .btn{appearance:none;border:1px solid var(--mint);background:var(--glass);color:var(--mintL);
    padding:.85rem 1.4rem;border-radius:999px;letter-spacing:.08em;text-transform:uppercase;
    font-weight:700;backdrop-filter:blur(6px);cursor:pointer;transition:box-shadow .2s,transform .1s,opacity .2s;
    box-shadow:0 0 16px rgba(156,255,224,.14);font-size:13px;position:relative;overflow:hidden;user-select:none}
  .btn:hover{box-shadow:0 0 26px rgba(156,255,224,.45),0 0 24px rgba(47,176,233,.25)}
  .btn:active{transform:translateY(1px)}
  .btn.hidden{display:none}
  .btn.locked{opacity:.55;cursor:not-allowed}
  .btn-row{display:flex;gap:10px;flex-wrap:wrap;justify-content:center}

  /* Preview */
  #preview{display:none;position:relative;width:min(94vw,960px);aspect-ratio:16/10;border-radius:16px;overflow:hidden;border:1px solid var(--stroke);box-shadow:0 0 24px rgba(156,255,224,.14)}
  #preview img,#preview video{width:100%;height:100%;object-fit:cover}
  #edgeGlow{position:absolute;inset:0;border-radius:16px;pointer-events:none;opacity:0;box-shadow:0 0 28px rgba(156,255,224,.6),inset 0 0 18px rgba(14,139,103,.55);transition:opacity .25s}
  .glow-on #edgeGlow{opacity:1}
  .wheel{position:absolute;inset:auto auto 10px 10px;background:rgba(0,0,0,.45);border:1px solid var(--stroke);
    border-radius:999px;padding:.35rem .6rem;font-size:12px;display:flex;gap:.5rem;align-items:center}
  .mini-spin{width:14px;height:14px;border-radius:50%;border:2px solid rgba(156,255,224,.35);border-top-color:var(--mintL);animation:spin 1s linear infinite}
  @keyframes spin{to{transform:rotate(360deg)}}

  /* Tips under photo (no chat boxes) */
  #tips{position:relative;width:min(94vw,960px);min-height:14px}
  .tip{opacity:0;transform:translateY(8px);transition:all .4s ease;background:rgba(255,255,255,.06);
    border:1px solid var(--stroke);backdrop-filter:blur(8px);color:var(--text);padding:.55rem .75rem;border-radius:10px;
    box-shadow:0 0 18px rgba(156,255,224,.25);margin:.35rem auto;max-width:92%}
  .tip.show{opacity:1;transform:translateY(0)}
  .tip.right{text-align:right}

  /* HUD labels */
  .hud{display:none;gap:8px;margin-top:8px;flex-wrap:wrap;justify-content:center}
  .tab{padding:.45rem .8rem;border:1px solid var(--stroke);border-radius:999px;background:rgba(255,255,255,.04);color:var(--textDim);font-size:12px}

  /* Footer */
  .footer{position:fixed;left:50%;transform:translateX(-50%);bottom:18px;font-size:12px;color:rgba(233,255,246,.6);letter-spacing:.12em;text-transform:uppercase}

  /* Garage roll-down */
  #garageDoor{position:fixed;left:0;right:0;top:0;height:0;overflow:hidden;z-index:70;pointer-events:none}
  #garageDoor .door{height:430px;background:
      linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.03)),
      repeating-linear-gradient(180deg, rgba(156,255,224,.08), rgba(156,255,224,.08) 6px, rgba(255,255,255,0.02) 6px, rgba(255,255,255,0.02) 14px);
    border-bottom:1px solid var(--stroke); box-shadow:0 10px 40px rgba(0,0,0,.45), inset 0 -8px 24px rgba(156,255,224,.12);
    display:flex;flex-direction:column;align-items:center;justify-content:flex-start;gap:12px;padding:14px 10px; position:relative}
  #garageDoor.open{height:430px;pointer-events:auto;transition:height .9s cubic-bezier(.2,.9,.2,1)}
  #garageDoor.close{height:0;transition:height .8s cubic-bezier(.2,.9,.2,1)}
  .gTitle{font-weight:900;letter-spacing:.16em;color:var(--mintL);margin-top:4px}
  .gClose{position:absolute;right:10px;top:10px;border:1px solid var(--stroke);background:rgba(255,255,255,.04);color:var(--text);border-radius:999px;padding:.35rem .6rem;cursor:pointer}
  .gRow{display:flex;gap:12px;max-width:980px;width:calc(100% - 20px);justify-content:center;flex-wrap:wrap;margin-top:6px}
  .card{flex:1 1 280px;max-width:320px;background:rgba(255,255,255,.05);border:1px solid var(--stroke);border-radius:14px;padding:12px 12px 14px;box-shadow:0 0 26px rgba(156,255,224,.18)}
  .tag{display:inline-block;border:1px solid var(--mint);color:var(--mintL);padding:.25rem .5rem;border-radius:999px;font-size:11px;margin-bottom:8px}
  .price{margin-top:8px;opacity:.9}
  .card .btn-row{justify-content:flex-start}

  /* Paywall overlay */
  .overlay{display:none;position:fixed;inset:0;background:rgba(3,8,6,.82);backdrop-filter:blur(6px);align-items:center;justify-content:center;z-index:80}
  .panel{max-width:560px;margin:20px;background:rgba(255,255,255,.06);border:1px solid var(--stroke);
    border-radius:16px;padding:1.1rem 1.3rem;text-align:center;box-shadow:0 0 32px rgba(156,255,224,.28)}

  /* Boot Chamber (pre-landing, ~2.5s) */
  #bootChamber{position:fixed;inset:0;background:#030e0b;z-index:100;display:flex;align-items:center;justify-content:center;flex-direction:column}
  #bootSpinner{display:flex;gap:.5rem;align-items:center;border:1px solid var(--stroke);background:rgba(255,255,255,.05);padding:.6rem .9rem;border-radius:999px;box-shadow:0 0 18px rgba(156,255,224,.25)}
  #bootLog{margin-top:14px;width:min(92vw,820px);height:120px;border:1px solid var(--stroke);border-radius:10px;background:rgba(0,0,0,.35);
    padding:8px 10px;font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;color:#a8ffea;overflow:hidden;box-shadow:0 0 22px rgba(156,255,224,.18)}
  .logline{opacity:.1;transform:translateY(4px);transition:opacity .35s ease, transform .35s ease;font-size:12px;line-height:1.45}
  .logline.show{opacity:1;transform:translateY(0)}
  #bootDedication{position:absolute;bottom:12%;left:0;right:0;text-align:center;font-size:14px;color:rgba(156,255,224,.75);letter-spacing:.12em;opacity:0;transition:opacity 1.2s ease;font-weight:500}
  .bloom{animation:bloom 900ms ease forwards}
  @keyframes bloom{0%{filter:brightness(.8) blur(1px)}40%{filter:brightness(1.4) blur(2px)}100%{filter:brightness(1) blur(0)}}
</style>
</head>
<body>
  <div class="topbar"><div class="brand"><span class="hero">HEROHUD</span></div></div>
  <div class="topright">
    <button class="iconbtn" id="btnFullscreen" title="Fullscreen">‚õ∂</button>
    <button class="iconbtn" id="btnGarage" title="Garage">üß∞</button>
  </div>

  <!-- Boot Chamber -->
  <div id="bootChamber">
    <div id="bootSpinner"><div class="mini-spin"></div><span>Waking up‚Ä¶</span></div>
    <div id="bootLog"></div>
    <div id="bootDedication">Dedicated to Addison ‚Äî the spark behind every brave start.</div>
  </div>

  <!-- Garage roll-down -->
  <div id="garageDoor" class="close">
    <div class="door">
      <button class="gClose" id="garageCloseBtn">Close</button>
      <div class="gTitle">GARAGE ‚Ä¢ Cardinal-Garage_MND.inc</div>
      <div style="opacity:.85;font-size:12px;margin-top:-4px">Founders ‚Ä¢ Sales University ‚Ä¢ Upgrades ‚Ä¢ Control Center</div>

      <div class="gRow">
        <div class="card">
          <span class="tag">üü¢ Access+</span>
          <div>Unlimited analyzing ‚Äî scan as much as you want.</div>
          <div class="price">$25 / month</div>
          <div class="btn-row"><button class="btn" id="btnAccessMonthly">Activate</button></div>
        </div>

        <div class="card">
          <span class="tag">‚ö° Pro Sales Insight</span>
          <div>Client-ready report with sales insight.</div>
          <div class="price">
            <label><input type="radio" name="proMode" value="single" checked> $39 / report</label><br/>
            <label><input type="radio" name="proMode" value="unlimited"> $89 / month</label>
          </div>
          <div class="btn-row"><button class="btn" id="btnProActivate">Activate</button></div>
        </div>

        <div class="card">
          <span class="tag">üéì Sales University</span>
          <div>One-week sprint from elite systems ‚Äî Junior track included (Addie).</div>
          <div class="price">$99 / week</div>
          <div class="btn-row">
            <button class="btn" id="btnSalesU">Enter</button>
            <button class="btn" id="btnSalesUDemo">Grant 1 Extra Demo</button>
          </div>
        </div>

        <div class="card">
          <span class="tag">üß† Hero Complete</span>
          <div>All systems: Access+, Pro, SalesU, Founders‚Äô tools.</div>
          <div class="price">$129 / month</div>
          <div class="btn-row"><button class="btn" id="btnHeroComplete">Activate</button></div>
        </div>

        <div class="card">
          <span class="tag">üìä Founder‚Äôs Control Center</span>
          <div>Pitch, org, stack, projections ‚Äî one PDF.</div>
          <div class="btn-row">
            <button class="btn" id="btnFounderDeck">Generate Deck (PDF)</button>
            <button class="btn" id="btnDownloadLogs">Download Logs</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Main UI -->
  <div class="stage">
    <div class="stack">
      <div class="btn-row">
        <button class="btn" id="btnUpload">‚¨Ü Upload Photo</button>
        <button class="btn" id="btnCamera">üì∑ Camera</button>
        <button class="btn" id="btnAnalyze">üîç Analyze</button>
        <button class="btn hidden" id="btnExport">üì§ Pro Export</button>
      </div>

      <div id="preview">
        <img id="previewImg" alt="preview" />
        <div id="edgeGlow"></div>
        <div class="wheel" id="wheel" style="display:none;"><div class="mini-spin"></div><span id="wheelText">Analyzing‚Ä¶</span></div>
        <div id="dashHint" style="position:absolute;inset:0;opacity:.0;pointer-events:none;"></div>
      </div>

      <!-- Tips (only) -->
      <div id="tips"></div>

      <!-- Labels for modules -->
      <div class="hud" id="hudTabs">
        <div class="tab">Insights</div>
        <div class="tab">Field Guides</div>
        <div class="tab">Sales U.</div>
        <div class="tab">Best Practices</div>
        <div class="tab">Ledger</div>
        <div class="tab">Founders</div>
      </div>

      <input type="file" id="file" accept="image/*" hidden />
    </div>
  </div>

  <div class="footer">Powered by Cardinal-Garage_MND.inc</div>

  <!-- Generic paywall overlay -->
  <div class="overlay" id="paywall">
    <div class="panel">
      <h3 id="paywallTitle">Upgrade Required</h3>
      <p id="paywallMsg" class="sub">Unlock to continue.</p>
      <div class="btn-row">
        <button class="btn" id="btnProOnce">$39 / report</button>
        <button class="btn" id="btnProMonthly">$89 / month</button>
        <button class="btn" id="btnPaywallClose">Close</button>
      </div>
    </div>
  </div>

<script>
(() => {
  /* =========================
     CONFIG
  ==========================*/
  const API = (location.hostname.includes("localhost")||location.hostname.includes("127.0.0.1"))
    ? "http://localhost:3001"
    : "https://jared-hero2-backend.onrender.com";

  /* =========================
     ELEMENTS
  ==========================*/
  const el = {
    file: qs('#file'),
    btnUpload: qs('#btnUpload'),
    btnCamera: qs('#btnCamera'),
    btnAnalyze: qs('#btnAnalyze'),
    btnExport: qs('#btnExport'),
    preview: qs('#preview'),
    previewImg: qs('#previewImg'),
    edgeGlow: qs('#edgeGlow'),
    wheel: qs('#wheel'),
    wheelText: qs('#wheelText'),
    dashHint: qs('#dashHint'),
    tips: qs('#tips'),
    hudTabs: qs('#hudTabs'),
    btnGarage: qs('#btnGarage'),
    garageDoor: qs('#garageDoor'),
    garageCloseBtn: qs('#garageCloseBtn'),
    paywall: qs('#paywall'),
    paywallTitle: qs('#paywallTitle'),
    paywallMsg: qs('#paywallMsg'),
    btnProOnce: qs('#btnProOnce'),
    btnProMonthly: qs('#btnProMonthly'),
    btnPaywallClose: qs('#btnPaywallClose'),
    btnAccessMonthly: qs('#btnAccessMonthly'),
    btnProActivate: qs('#btnProActivate'),
    btnSalesU: qs('#btnSalesU'),
    btnSalesUDemo: qs('#btnSalesUDemo'),
    btnHeroComplete: qs('#btnHeroComplete'),
    btnFounderDeck: qs('#btnFounderDeck'),
    btnDownloadLogs: qs('#btnDownloadLogs'),
    btnFullscreen: qs('#btnFullscreen'),
    boot: {
      chamber: qs('#bootChamber'),
      spinner: qs('#bootSpinner'),
      log: qs('#bootLog'),
      dedication: qs('#bootDedication')
    }
  };

  /* =========================
     STATE
  ==========================*/
  const STATE = {
    proUnlocked: localStorage.getItem('herohud_pro_unlocked')==='1',
    accessUnlocked: localStorage.getItem('herohud_access_unlocked')==='1',
    salesUDemo: localStorage.getItem('herohud_salesu_demo')==='1',
    lastSummary: "",
    logs: loadLogs(), // { entries: [], startedAt }
    demoCycleDone: localStorage.getItem('herohud_demo_cycle_done')==='1', // first full run completed
    speaking: false,
    proMode: 'single' // 'single' | 'unlimited'
  };

  /* =========================
     UTIL
  ==========================*/
  function qs(s){return document.querySelector(s)}
  function nowKey(){ const d=new Date(); return d.getFullYear()+'-'+(d.getMonth()+1)+'-'+d.getDate() }
  function logEvent(kind, payload){ STATE.logs.entries.push({ t:Date.now(), kind, payload }); localStorage.setItem('herohud_logs', JSON.stringify(STATE.logs)); }
  function loadLogs(){ const raw = localStorage.getItem('herohud_logs'); return raw ? JSON.parse(raw) : { startedAt: Date.now(), entries: [] }; }
  function downloadText(filename, text){ const blob=new Blob([text],{type:"text/plain"}); const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download=filename; a.click(); }
  function wait(ms){ return new Promise(r=>setTimeout(r,ms)) }
  function ensureTips(){ if(!el.tips){ const d=document.createElement('div'); d.id='tips'; document.body.appendChild(d); el.tips=d; } }

  /* =========================
     FULLSCREEN
  ==========================*/
  el.btnFullscreen?.addEventListener('click', () => {
    if (!document.fullscreenElement) document.documentElement.requestFullscreen().catch(()=>{});
    else document.exitFullscreen().catch(()=>{});
  });

  /* =========================
     SPEECH (Jared + Addie, natural)
  ==========================*/
  let speakQueue = []; let isSpeaking = false;
  function pickVoice(gender="male"){
    const voices = speechSynthesis.getVoices();
    const male = /(Daniel|Alex|Matthew|Aaron|Google US English|Male)/i;
    const female = /(Samantha|Zira|Amelia|Google US English Female|Female)/i;
    const pref = gender === "female" ? female : male;
    return voices.find(v => pref.test(v.name)) || voices.find(v => v.default) || voices[0];
  }
  function speak(line, { gender="male", priority=2 } = {}){
    if(priority===1){ speechSynthesis.cancel(); isSpeaking=false; speakQueue=[]; }
    speakQueue.push({ line, gender });
    processSpeakQueue();
  }
  function processSpeakQueue(){
    if(isSpeaking || speakQueue.length===0) return;
    const next = speakQueue.shift(); if(!next) return;
    isSpeaking = true;
    const u = new SpeechSynthesisUtterance(next.line);
    u.voice = pickVoice(next.gender);
    u.rate  = next.gender === "female" ? 1.0 : 0.93;
    u.pitch = next.gender === "female" ? 1.18 : 1.02;
    u.volume= 1.0;
    u.onend = u.onerror = ()=>{ isSpeaking=false; processSpeakQueue(); };
    speechSynthesis.speak(u);
    logEvent('voice', { text: next.line, gender: next.gender });
  }

  /* =========================
     BOOT CHAMBER (~2.5s total)
  ==========================*/
  const BOOT_LINES = [
    "> Jared systems cold.",
    "> Checking API endpoints‚Ä¶",
    "> Backend live.",
    "> Please allow Jared to wake up."
  ];
  async function boot(){
    // Seed voices (Chrome quirk)
    speechSynthesis.getVoices();

    // Log lines fast to fit ~2.5s
    let t = 150;
    BOOT_LINES.forEach((line,i)=>{
      setTimeout(()=>{
        const d = document.createElement('div');
        d.className='logline'; d.textContent = line;
        el.boot.log.appendChild(d);
        requestAnimationFrame(()=>d.classList.add('show'));
      }, t);
      t += 450;
    });

    // Dedication fade at ~1.1s
    setTimeout(()=>{ el.boot.dedication.style.opacity = 1; }, 1100);

    // Jared enters at ~2.0s
    setTimeout(()=>{
      speak("System awake. Let's get to work.", { gender: "male", priority: 1 });
      el.boot.chamber.classList.add('bloom');
    }, 2000);

    // Exit boot at ~2.5s
    setTimeout(()=>{ el.boot.chamber.style.display='none'; }, 2500);
  }

  /* =========================
     GARAGE
  ==========================*/
  function openGarage(){
    el.garageDoor.classList.remove('close'); el.garageDoor.classList.add('open');
    speak("Garage opened. Upgrades, training, and founder tools are available here.", {gender:"male"});
  }
  function closeGarage(){
    el.garageDoor.classList.remove('open'); el.garageDoor.classList.add('close');
  }

  /* =========================
     PAYWALL
  ==========================*/
  function openPaywall(title,msg){
    el.paywallTitle.textContent = title;
    el.paywallMsg.textContent = msg;
    el.paywall.style.display='flex';
  }
  function closePaywall(){ el.paywall.style.display='none' }

  /* =========================
     CAMERA
  ==========================*/
  let camStream=null,camVideo=null,captureBtn=null;
  async function openCamera(){
    if(STATE.demoCycleDone && !STATE.accessUnlocked){
      speak("You've used your free run. Access Plus unlocks unlimited analyzing.", {gender:"male"});
      openPaywall("Access+ Required","Unlimited analyzing for $25/month.");
      return;
    }
    try{
      const stream=await navigator.mediaDevices.getUserMedia({video:true});
      camStream=stream;
      camVideo=document.createElement("video");
      camVideo.playsInline=true; camVideo.muted=true; camVideo.srcObject=stream; await camVideo.play();
      el.preview.style.display='block'; previewReplaceWithNode(camVideo); ensureCaptureBtn();
      speak("Camera online. Capture when ready.", {gender:"male"});
    }catch(e){ showTip("Camera access denied.",true); }
  }
  function ensureCaptureBtn(){
    if(captureBtn) captureBtn.remove();
    captureBtn=document.createElement("button");
    captureBtn.textContent="üì∏ Capture"; captureBtn.className="btn";
    captureBtn.style.position="absolute"; captureBtn.style.right="10px"; captureBtn.style.bottom="10px";
    el.preview.appendChild(captureBtn);
    captureBtn.onclick=async()=>{
      if(!camVideo) return;
      const canvas=document.createElement("canvas");
      canvas.width=camVideo.videoWidth||1280; canvas.height=camVideo.videoHeight||720;
      const g=canvas.getContext("2d"); g.drawImage(camVideo,0,0,canvas.width,canvas.height);
      const blob=await new Promise(res=>canvas.toBlob(res,'image/jpeg',0.92));
      if(camStream){camStream.getTracks().forEach(t=>t.stop()); camStream=null;}
      camVideo=null;
      const url=URL.createObjectURL(blob); previewReplaceWithImage(url);
      el.preview.style.display='block'; el.dashHint.style.opacity=.25;
      el.file._capturedBlob = blob;
      showTip("Captured ‚Äî tap Analyze.", true);
      logEvent('camera_capture', { size: blob.size });
    };
  }

  /* =========================
     PREVIEW HELPERS
  ==========================*/
  function previewReplaceWithImage(url){
    const img=document.createElement("img");
    img.id="previewImg"; img.alt="preview"; img.src=url;
    previewReplaceWithNode(img);
  }
  function previewReplaceWithNode(node){
    const old=el.preview.querySelector("img,video");
    if(old) old.replaceWith(node); else el.preview.prepend(node);
  }

  /* =========================
     TIPS
  ==========================*/
  function showTip(text,right=false){
    ensureTips();
    const t = document.createElement('div');
    t.className = 'tip'+(right?' right':'' );
    t.textContent = text;
    el.tips.appendChild(t);
    requestAnimationFrame(()=>t.classList.add('show'));
    setTimeout(()=>{ t.classList.remove('show'); setTimeout(()=>t.remove(),380); }, 4200);
  }
  function showAnalysisTips(summary){
    const bits=(summary||"Consider mulch depth; define bed edge; check irrigation coverage.")
      .replace(/\s+/g,' ').trim().split(/[.;]/).map(s=>s.trim()).filter(Boolean).slice(0,3);
    let delay=240;
    bits.forEach((b,i)=>{ setTimeout(()=>showTip("üí° "+b, i%2===1), delay); delay+=1400; });
    setTimeout(()=>showTip("üßæ Pro Sales Insight available ‚Äî tap Pro Export.", true), delay+260);
  }

  /* =========================
     ANALYZE
  ==========================*/
  el.btnAnalyze.addEventListener('click', async ()=>{
    if(!el.preview.style.display || el.preview.style.display==='none'){
      showTip("Upload or capture a photo first.", true); return;
    }
    // After first full cycle, require Access+ for analyzing
    if(STATE.demoCycleDone && !STATE.accessUnlocked){
      speak("You've used your free analysis. Unlock Access Plus for unlimited analyzing.", {gender:"male"});
      openPaywall("Access+ Required","Unlimited analyzing for $25/month.");
      return;
    }

    const blob = el.file._capturedBlob;
    const fileEl = el.file.files && el.file.files[0];
    if(!blob && !fileEl){ showTip("No image found.", true); return; }

    el.preview.classList.add('glow-on');
    el.wheel.style.display='flex'; el.wheelText.textContent = "Analyzing‚Ä¶";
    const formData=new FormData();
    if(blob) formData.append("file",blob,"capture.jpg"); else formData.append("file",fileEl);

    try{
      speak("Analyzing image.", {gender:"male"});
      logEvent('analyze_start', {});
      const resp = await fetch(`${API}/analyze-image`, { method:"POST", body:formData });
      const data = await resp.json();
      const summary = data.summary || "Analysis complete.";
      STATE.lastSummary = summary;
      logEvent('analyze_result', { summary });

      // Speak summary and show tips
      speak(summary, {gender:"male"});
      showAnalysisTips(summary);

      el.hudTabs.style.display='flex';
      el.btnExport.classList.remove('hidden');
      el.dashHint.style.opacity=.6;

      // Mark demo cycle complete after first analysis succeeds
      if(!STATE.demoCycleDone){
        localStorage.setItem('herohud_demo_cycle_done','1');
        STATE.demoCycleDone = true;
        showTip("Demo complete ‚Äî export is unlocked for this run.", true);
      }
    }catch(e){
      showTip("‚ùå Analysis failed.", true);
      logEvent('analyze_error', { msg: String(e) });
      speak("Analysis failed. Please try again.", {gender:"male"});
    } finally {
      el.wheel.style.display='none';
      el.preview.classList.remove('glow-on');
    }
  });

  /* =========================
     EXPORT (Pro paywall only after first run)
  ==========================*/
  el.btnExport.addEventListener('click', ()=>{
    if(!STATE.proUnlocked){
      speak("Pro Sales Insight required to export a client-ready report.", {gender:"male"});
      openPaywall("Pro Sales Insight Required","Choose single $39/report or $89/month unlimited.");
      return;
    }
    triggerExport();
  });

  async function triggerExport(){
    try{
      logEvent('export_start', {});
      speak("Generating your professional report.", {gender:"male"});
      const tipsTxt=[...document.querySelectorAll('.tip')].map(e=>e.textContent.trim()).join("\n");
      const payload = { summary: STATE.lastSummary || "", tips: tipsTxt || "", logs: STATE.logs };
      const resp = await fetch(`${API}/export`, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload) });

      if(resp.ok && resp.headers.get('content-type')?.includes('application/pdf')){
        const blob = await resp.blob();
        const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download="herohud_pro_report.pdf"; a.click();
      }else{
        const fallback = `HeroHUD Pro Report\n\nSummary:\n${payload.summary}\n\nTips:\n${payload.tips}\n\n(Voice log available via Garage ‚Üí Download Logs)`;
        downloadText("herohud_pro_report.txt", fallback);
      }
      logEvent('export_done', {});
      speak("Report ready.", {gender:"male"});
    }catch(e){
      logEvent('export_error', { msg:String(e) });
      showTip("Export failed. Try again.", true);
      speak("Export failed. Please try again.", {gender:"male"});
    }
  }

  /* =========================
     FILE UPLOAD + CAMERA WIRE
  ==========================*/
  el.btnUpload.addEventListener('click', ()=> {
    // First cycle always free. Afterwards, uploads are allowed, but analyze is gated (as designed).
    el.file.click();
  });
  el.file.addEventListener('change', ()=>{
    const f=el.file.files[0]; if(!f) return;
    const url=URL.createObjectURL(f);
    previewReplaceWithImage(url);
    el.preview.style.display='block';
    el.dashHint.style.opacity=.25;
    showTip("Photo loaded ‚Äî tap Analyze.", true);
    logEvent('upload', { name:f.name, size:f.size });
  });
  el.btnCamera.addEventListener('click', openCamera);

  /* =========================
     GARAGE WIRE
  ==========================*/
  el.btnGarage.addEventListener('click', openGarage);
  el.garageCloseBtn.addEventListener('click', closeGarage);

  // Access+
  el.btnAccessMonthly?.addEventListener('click', ()=>{
    localStorage.setItem('herohud_access_unlocked','1');
    STATE.accessUnlocked = true;
    speak("Access Plus confirmed. Unlimited analyzing is live.", {gender:"male"});
  });

  // Pro Sales Insight
  el.btnProActivate?.addEventListener('click', ()=>{
    const choice = document.querySelector('input[name="proMode"]:checked')?.value || 'single';
    STATE.proMode = choice;
    localStorage.setItem('herohud_pro_unlocked','1');
    STATE.proUnlocked = true;
    speak(choice==='single'
      ? "Single report mode selected. Pro Sales Insight ready at thirty-nine dollars per export."
      : "Unlimited Pro Sales Insight activated at eighty-nine dollars per month."
    , {gender:"male"});
  });

  // Sales U (Addie)
  el.btnSalesU?.addEventListener('click', ()=>{
    speak("Welcome to Sales University. I‚Äôm Addie ‚Äî your guide for the week. Let‚Äôs build your wins, one client at a time.", {gender:"female"});
  });
  el.btnSalesUDemo?.addEventListener('click', ()=>{
    localStorage.setItem('herohud_salesu_demo','1');
    STATE.salesUDemo = true;
    speak("One additional analysis demo has been granted. Use it to practice a real job.", {gender:"female"});
  });

  // Hero Complete
  el.btnHeroComplete?.addEventListener('click', ()=>{
    localStorage.setItem('herohud_access_unlocked','1');
    localStorage.setItem('herohud_pro_unlocked','1');
    STATE.accessUnlocked = true; STATE.proUnlocked = true;
    speak("Hero Complete activated. All systems at full capacity ‚Äî welcome to command mode.", {gender:"male"});
  });

  // Founder Deck + Logs
  el.btnFounderDeck?.addEventListener('click', async ()=>{
    try{
      const resp = await fetch(`${API}/founder-report`, { method: 'POST' });
      if(!resp.ok) throw new Error('Founder report failed');
      const blob = await resp.blob();
      const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download = "HeroHUD_FoundersDeck.pdf"; a.click();
      speak("Founder‚Äôs Deck generated.", {gender:"male"});
    }catch(e){
      showTip("Founder‚Äôs Deck generation failed.", true);
      speak("Founder‚Äôs Deck generation failed. Please try again.", {gender:"male"});
    }
  });
  el.btnDownloadLogs?.addEventListener('click', ()=>{
    const text = JSON.stringify(STATE.logs, null, 2);
    downloadText("herohud_logs.txt", text);
    speak("Log archive downloaded.", {gender:"male"});
  });

  /* =========================
     INIT
  ==========================*/
  window.addEventListener('load', async () => {
    // Kick off Boot Chamber (2.5s cinematic)
    await boot();
  });

})();
</script>
</body>
</html>
