<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,maximum-scale=1,user-scalable=no" />
<title>Hero Pro â€¢ JARED HUD</title>
<meta name="theme-color" content="#0b1b16" />
<style>
  html,body {
    margin:0; height:100%; background:#0b1b16; overflow:hidden;
    touch-action:none; -webkit-user-select:none; user-select:none;
    -webkit-tap-highlight-color:transparent;
  }
</style>
</head>
<body>
<canvas id="hud"></canvas>

<script>
(() => {
  // ===== API base =====
  const API = (location.hostname.includes("localhost")||location.hostname.includes("127.0.0.1"))
    ? "http://localhost:3001"
    : "https://jared-hero2-backend.onrender.com";

  // ===== Brand =====
  const BRAND = {
    bgTop:'#0b1b16', bgBot:'#07100d',
    mintL:'#77FFCE', mintB:'#34D1A0', text:'#E9FFF6', textDim:'rgba(233,255,246,.85)',
    auraS:'rgba(119,255,206,.15)', auraM:'rgba(119,255,206,.35)', auraH:'rgba(119,255,206,.55)'
  };

  // ===== Icons =====
  const defs = [
    { id:'upload',  label:'Upload', desc:'Choose a yard photo.', icon:'â¬†ï¸' },
    { id:'camera',  label:'Camera', desc:'Take a live photo.', icon:'ðŸ“·' },
    { id:'analyze', label:'Estimate', desc:'Run pricing & AI tips.', icon:'ðŸ§®' },
    { id:'talk',    label:'Talk to JARED', desc:'Tap to speak, tap again to stop.', icon:'ðŸŽ¤' },
    { id:'export',  label:'Export Estimate', desc:'Save notes & pro insights.', icon:'ðŸ“¤' },
    { id:'school',  label:'Sales University', desc:'Playbooks & closers.', icon:'ðŸŽ“' },
    { id:'full',    label:'Fullscreen', desc:'Toggle full HUD.', icon:'â›¶' },
  ];
  const ICONS = [];

  // ===== Canvas Setup =====
  const cvs = document.getElementById('hud');
  const ctx = cvs.getContext('2d', { alpha:false });
  let DPR = Math.max(1, Math.min(3, devicePixelRatio||1));
  const S = { w:0,h:0,t:0, tx:0,ty:0 };

  function layoutIcons() {
    ICONS.length = 0;
    const sodH = Math.max(120, Math.min(220, S.h * 0.22));
    const baseY = S.h - sodH + 8;
    const pad = 50;
    const gap = (S.w - pad * 2) / (defs.length - 1);
    defs.forEach((d, i) => {
      ICONS.push({ ...d, x: pad + i * gap, y: S.h + 120, targetY: baseY - 80, r: 46, hover:false });
    });
  }

  function resize(){
    DPR = Math.max(1, Math.min(3, devicePixelRatio||1));
    S.w = innerWidth; S.h = innerHeight;
    cvs.width = Math.floor(S.w*DPR);
    cvs.height = Math.floor(S.h*DPR);
    cvs.style.width = S.w+'px';
    cvs.style.height = S.h+'px';
    ctx.setTransform(DPR,0,0,DPR,0,0);
    layoutIcons();
  }
  addEventListener('resize', resize, {passive:true});
  resize();

  // ====== State ======
  const bubbles = [];
  const tips = [];
  const savedInsights = [];
  let talkState = 'idle', greeted=false, firstPreviewDone=false;
  let rec=null, canListen=true, speechAudio=null, micPrimed=false;
  let lastFile=null;
  const photo={img:null,url:null,w:0,h:0,x:0,y:0,show:false,glow:0.4};

  // ===== File + Camera =====
  const fileInput = document.createElement("input");
  fileInput.type="file"; fileInput.accept="image/*"; fileInput.style.display="none";
  document.body.appendChild(fileInput);
  function chooseFile(){ fileInput.value=""; fileInput.click(); }
  fileInput.onchange=()=>{ loadPhoto(fileInput.files[0]); };

  async function takePhoto() {
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ video:true });
      const video = document.createElement('video');
      video.srcObject = stream;
      await video.play();
      const canvas = document.createElement('canvas');
      canvas.width = video.videoWidth; canvas.height = video.videoHeight;
      const cctx = canvas.getContext('2d');
      cctx.drawImage(video,0,0);
      stream.getTracks().forEach(t=>t.stop());
      canvas.toBlob(blob => loadPhoto(new File([blob],'photo.jpg',{type:'image/jpeg'})));
    } catch(e){ toast('Camera access denied.'); }
  }

  function loadPhoto(f){
    if (!f) return;
    lastFile=f;
    if (photo.url) URL.revokeObjectURL(photo.url);
    photo.url=URL.createObjectURL(f);
    photo.img=new Image();
    photo.img.onload=()=>{
      photo.w=photo.img.width; photo.h=photo.img.height;
      photo.show=true; photo.glow=0.8;
      toast("âœ… Photo loaded. Tap Estimate.");
      if (!firstPreviewDone) firstPreviewDone=true;
    };
    photo.img.src=photo.url;
  }

  // ===== Drawing Helpers =====
  function roundRect(g,x,y,w,h,r){ const rr=Math.min(r,w/2,h/2); g.beginPath(); g.moveTo(x+rr,y); g.arcTo(x+w,y,x+w,y+h,rr); g.arcTo(x+w,y+h,x,y+h,rr); g.arcTo(x,y+h,x,y,rr); g.arcTo(x,y,x+w,y,rr); g.closePath(); }
  function halo(r,color,blur){ ctx.save(); ctx.shadowColor=color; ctx.shadowBlur=blur; ctx.beginPath(); ctx.arc(0,0,r,0,Math.PI*2); ctx.strokeStyle='transparent'; ctx.stroke(); ctx.restore(); }

  // ===== Background =====
  function drawBackground(t){
    const g=ctx.createLinearGradient(0,0,0,S.h);
    g.addColorStop(0,BRAND.bgTop);
    g.addColorStop(1,BRAND.bgBot);
    ctx.fillStyle=g; ctx.fillRect(0,0,S.w,S.h);
    const rg=ctx.createRadialGradient(S.w/2,S.h*0.85,0,S.w/2,S.h*0.85,Math.max(S.w,S.h)*0.55);
    rg.addColorStop(0,BRAND.auraM); rg.addColorStop(1,'transparent');
    ctx.fillStyle=rg; ctx.fillRect(0,0,S.w,S.h);
  }

  // ===== Photo Display =====
  function drawPhoto(){
    if (!photo.show||!photo.img) return;
    const maxW=S.w*0.9, maxH=S.h*0.45;
    let w=photo.w,h=photo.h; const scale=Math.min(maxW/w,maxH/h);
    w*=scale; h*=scale;
    photo.x=(S.w-w)/2; photo.y=S.h*0.12;
    ctx.save(); ctx.globalAlpha=photo.glow;
    ctx.drawImage(photo.img,photo.x,photo.y,w,h);
    ctx.restore();
  }

  // ===== Floating Tips =====
  function spawnTip(msg){
    if(tips.length>=3) tips.shift();
    const x=photo.x+Math.random()*photo.w;
    const y=photo.y+Math.random()*photo.h;
    tips.push({msg,x,y,start:performance.now(),life:3000});
  }
  function drawTips(){
    const now=performance.now();
    tips.forEach(tip=>{
      const a=1-(now-tip.start)/tip.life;
      if(a<=0) return;
      ctx.save();
      ctx.globalAlpha=a*0.8;
      ctx.fillStyle='rgba(119,255,206,0.25)';
      ctx.beginPath(); ctx.arc(tip.x, tip.y-(1-a)*40, 24, 0, Math.PI*2); ctx.fill();
      ctx.fillStyle=BRAND.text; ctx.font='600 12px system-ui'; ctx.textAlign='center';
      ctx.fillText(tip.msg, tip.x, tip.y-(1-a)*40+4);
      ctx.restore();
    });
  }

  // ===== AI Analyze =====
  async function analyze(){
    if(!lastFile){ toast("Upload first."); return; }
    const formData=new FormData(); formData.append("file",lastFile);
    toast("Analyzing...");
    try{
      const resp=await fetch(`${API}/analyze-image`,{method:"POST",body:formData});
      const data=await resp.json();
      toast(data.summary||"No summary.");
      spawnTip("Upsell mulch color");
      setTimeout(()=>spawnTip("Check slope depth"),800);
      setTimeout(()=>spawnTip("Add edging estimate"),1600);
      await speak(data.summary);
      savedInsights.push(`PHOTO:\n${data.summary}\n`);
    }catch(e){ toast("âŒ Analysis failed."); }
  }

  function exportInsights(){
    if(!savedInsights.length){ toast("No insights."); return; }
    const blob=new Blob([savedInsights.join("\n\n")],{type:"text/plain"});
    const a=document.createElement("a");
    a.href=URL.createObjectURL(blob); a.download="jared_estimates.txt"; a.click();
    toast("Insights exported!");
  }
  function openSchool(){ window.open("https://cardland51-bot.github.io/sales-university/","_blank"); }
  function toggleFull(){ if(!document.fullscreenElement)cvs.requestFullscreen(); else document.exitFullscreen(); }

  // ===== Voice & Greeting =====
  function initRecognition(){
    if(!('webkitSpeechRecognition' in window)) return null;
    const r=new webkitSpeechRecognition();
    r.lang='en-US'; r.interimResults=false; r.continuous=false;
    r.onstart=()=>{talkState='listening';};
    r.onend=()=>{ if(talkState==='listening') talkState='thinking'; canListen=true; };
    r.onresult=async(e)=>{
      const text=e.results[0][0].transcript;
      try{
        const resp=await fetch(`${API}/inference`,{
          method:'POST', headers:{'Content-Type':'application/json'},
          body:JSON.stringify({ text })
        });
        const data=await resp.json(); const content=data.content||'No response';
        savedInsights.push(`[${new Date().toLocaleString()}]\nVOICE: "${text}"\n${content}\n`);
        toast(content); await speak(content);
      }catch(err){ toast('JARED unavailable.'); }
      talkState='idle';
    };
    return r;
  }
  rec=initRecognition();

  function primeMic(){ if(micPrimed||!rec)return; try{rec.start();rec.abort();micPrimed=true;}catch(e){} }
  addEventListener('touchstart',()=>primeMic(),{once:true,passive:true});
  addEventListener('click',()=>primeMic(),{once:true,passive:true});

  async function greet(){
    if(localStorage.getItem("jaredGreeted")==="true") return;
    localStorage.setItem("jaredGreeted","true");
    await new Promise(r=>setTimeout(r,700));
    await speak("Hola hola â€” yo yo yo, Jared here. I'm still in beta, so be patient, my friend. Click Upload Photo to start, then hit Estimate to see what I can do. This is your Hero Pro sandbox â€” where you learn to price, build, and sell like a beast.");
  }
  window.addEventListener('load',greet,{once:true});

  function startListening(){ if(!rec||!canListen)return; canListen=false; rec.start(); }
  function stopListening(){ if(rec) rec.stop(); }

  async function speak(text){
    if(!text)return;
    try{
      if(speechAudio){ speechAudio.pause(); speechAudio=null; }
      const r=await fetch(`${API}/speak`,{
        method:'POST',headers:{'Content-Type':'application/json'},
        body:JSON.stringify({ text })
      });
      if(!r.ok) throw new Error('TTS failed');
      const b=await r.blob(); const u=URL.createObjectURL(b);
      speechAudio=new Audio(u); await speechAudio.play();
    }catch(e){ console.log('TTS error:',e); }
  }

  // ===== Toast =====
  function toast(msg,ms=1600){ bubbles.push({msg,t:performance.now(),ms}); }
  function drawToasts(){
    const now=performance.now();
    bubbles.forEach((b,i)=>{
      const age=now-b.t;if(age>b.ms)return;
      const a=age<200?age/200:age>b.ms-250?(b.ms-age)/250:1;
      const w=Math.min(460,S.w*0.9),h=46,x=(S.w-w)/2,y=S.h-90-i*56;
      ctx.save(); ctx.globalAlpha=a*.95;
      ctx.fillStyle='rgba(10,26,20,.92)'; ctx.strokeStyle=BRAND.auraM; ctx.lineWidth=2;
      roundRect(ctx,x,y,w,h,12); ctx.fill(); ctx.stroke();
      ctx.fillStyle=BRAND.text; ctx.font='600 14px system-ui'; ctx.textAlign='center';
      ctx.textBaseline='middle'; ctx.fillText(b.msg,x+w/2,y+h/2+1);
      ctx.restore();
    });
    for(let i=bubbles.length-1;i>=0;i--) if(performance.now()-bubbles[i].t>bubbles[i].ms)bubbles.splice(i,1);
  }

  // ===== Icons =====
  function drawIcon(it,t){
    it.y+=(it.targetY-it.y)*0.12;
    const x=it.x,y=it.y,r=it.r;
    ctx.save(); ctx.translate(x,y);
    if(it.id==='talk'){
      if(talkState==='listening') halo(r+18,BRAND.auraH,24);
      else if(talkState==='thinking') halo(r+10,BRAND.auraM,18);
      else halo(r+12,BRAND.auraS,14);
    } else halo(r+12,it.hover?BRAND.auraM:BRAND.auraS,14);
    const grd=ctx.createRadialGradient(-r*.5,-r*.6,r*.2,0,0,r*1.2);
    grd.addColorStop(0,'#10281f'); grd.addColorStop(1,'#0a1a14');
    ctx.fillStyle=grd; roundRect(ctx,-r,-r,r*2,r*2,r*.42); ctx.fill();
    ctx.strokeStyle=it.hover?BRAND.mintL:BRAND.mintB;
    ctx.lineWidth=3; ctx.beginPath(); ctx.arc(0,0,r-3,0,Math.PI*2); ctx.stroke();
    ctx.font=Math.floor(r*.9)+'px serif'; ctx.textAlign='center'; ctx.textBaseline='middle';
    ctx.fillText(it.icon,0,2);
    ctx.font='600 13px system-ui'; ctx.fillStyle=BRAND.textDim;
    ctx.fillText(it.label,0,r+18);
    ctx.restore();
  }

  // ===== Sod =====
  function drawSod(t){
    const sodTop=S.h - Math.max(120, Math.min(220,S.h*0.22));
    const grd=ctx.createLinearGradient(0,sodTop,0,S.h);
    grd.addColorStop(0,'#0e241c'); grd.addColorStop(1,'#08130f');
    ctx.fillStyle=grd; ctx.fillRect(0,sodTop,S.w,S.h-sodTop);
    const blades=Math.floor(S.w/9);
    for(let i=0;i<blades;i++){
      const x=(i/(blades-1))*S.w;
      const h=22+Math.sin((i*0.6)+t*0.002)*6;
      const sway=Math.sin(t*0.003+i)*2+S.tx*1.2;
      ctx.strokeStyle=i%7===0?BRAND.mintL:BRAND.mintB;
      ctx.lineWidth=2; ctx.beginPath();
      ctx.moveTo(x,sodTop+2);
      ctx.quadraticCurveTo(x+sway,sodTop-h*0.6,x+sway*0.8,sodTop-h);
      ctx.stroke();
    }
  }

  // ===== Input =====
  let pressedIcon=null;
  function dist2(x1,y1,x2,y2){const dx=x2-x1,dy=y2-y1;return dx*dx+dy*dy;}
  function pickIcon(x,y){ let best=null,bestD=Infinity;
    for(const it of ICONS){ const R=it.r+20; const d2=dist2(x,y,it.x,it.y);
      if(d2<R*R&&d2<bestD){best=it.id;bestD=d2;} it.hover=(best===it.id);
    } return best; }
  function handlePress(x,y){ const id=pickIcon(x,y); if(!id)return; pressedIcon=id;
    if(id==='upload') chooseFile();
    if(id==='camera') takePhoto();
    if(id==='talk') startListening();
  }
  function handleRelease(){ if(!pressedIcon)return;
    const id=pressedIcon; pressedIcon=null;
    if(id==='talk') stopListening();
    if(id==='analyze') analyze();
    if(id==='export') exportInsights();
    if(id==='school') openSchool();
    if(id==='full') toggleFull();
  }
  function getXY(e){ const r=cvs.getBoundingClientRect();
    if(e.touches&&e.touches[0])return{x:e.touches[0].clientX-r.left,y:e.touches[0].clientY-r.top};
    return{x:e.clientX-r.left,y:e.clientY-r.top}; }
  cvs.addEventListener('pointerdown',e=>{const p=getXY(e);handlePress(p.x,p.y);e.preventDefault();});
  addEventListener('pointerup',e=>{handleRelease();e.preventDefault();});
  cvs.addEventListener('touchstart',e=>{const p=getXY(e);handlePress(p.x,p.y);e.preventDefault();});
  addEventListener('touchend',e=>{handleRelease();e.preventDefault();});

  // ===== Main Loop =====
  function tick(t){
    S.t=t;
    drawBackground(t);
    drawPhoto();
    drawTips();
    drawSod(t);
    ICONS.forEach(it=>drawIcon(it,t));
    drawToasts();
    requestAnimationFrame(tick);
  }
  requestAnimationFrame(tick);

})();
</script>
</body>
</html>
